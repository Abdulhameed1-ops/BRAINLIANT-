<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Brainliant â€” Master Anything</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --blue:#2563EB;--blue-dark:#1D4ED8;--blue-light:#EFF6FF;--blue-mid:#DBEAFE;
  --text:#0F172A;--muted:#64748B;--subtle:#94A3B8;--border:#E2E8F0;
  --white:#FFFFFF;--bg:#F8FAFC;
  --green:#10B981;--red:#EF4444;--gold:#F59E0B;--purple:#7C3AED;--orange:#F97316;
  --shadow:0 1px 3px rgba(0,0,0,.08);--shadow-md:0 4px 16px rgba(0,0,0,.08);
  --shadow-lg:0 10px 40px rgba(0,0,0,.12);--r:14px;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Poppins',sans-serif;min-height:100vh;overflow-x:hidden;font-size:15px}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pop{0%{transform:scale(.85);opacity:0}70%{transform:scale(1.05)}100%{transform:scale(1);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes xpBurst{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}40%{opacity:1}100%{opacity:0;transform:translate(-50%,-200%) scale(1.1)}}
@keyframes confettiFall{0%{transform:translateY(-10px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(540deg);opacity:0}}
@keyframes toastIn{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes toastOut{from{transform:translateX(-50%) translateY(0);opacity:1}to{transform:translateX(-50%) translateY(20px);opacity:0}}
@keyframes rankGlow{0%,100%{box-shadow:0 0 0 0 rgba(37,99,235,.3)}50%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes drawBar{from{width:0}to{width:var(--target)}}
@keyframes heatPop{from{transform:scale(0)}to{transform:scale(1)}}
@keyframes mascotFloat{0%,100%{transform:translateY(0) rotate(-1deg)}50%{transform:translateY(-10px) rotate(1deg)}}
@keyframes brainBounce{0%,100%{transform:translateY(0)}40%{transform:translateY(-8px)}70%{transform:translateY(-4px)}}
@keyframes brainRead{0%,100%{transform:rotate(0)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
@keyframes brainIdea{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}
@keyframes brainCheer{0%,100%{transform:translateY(0) scale(1)}40%{transform:translateY(-7px) scale(1.04)}}
@keyframes bubblePop{0%{opacity:0;transform:scale(.7) translateY(8px)}70%{transform:scale(1.04) translateY(-2px)}100%{opacity:1;transform:scale(1) translateY(0)}}
@keyframes typing{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes logoEntrance{0%{opacity:0;transform:scale(.5) rotate(-10deg)}70%{transform:scale(1.08) rotate(2deg)}100%{opacity:1;transform:scale(1) rotate(0)}}

/* â”€â”€ MASCOT COMPANION â€” persistent across all pages â”€â”€ */
#mascot-companion{position:fixed;bottom:74px;right:14px;z-index:500;display:flex;flex-direction:column;align-items:flex-end;gap:0;pointer-events:none}
#mascot-companion.hidden{display:none}
.mascot-bubble{background:var(--white);border:2px solid var(--purple);border-radius:16px 16px 4px 16px;padding:10px 14px;font-size:.75rem;font-weight:600;color:var(--text);max-width:180px;line-height:1.45;box-shadow:0 4px 16px rgba(124,58,237,.18);animation:bubblePop .35s ease;position:relative;margin-bottom:6px}
.mascot-bubble::after{content:'';position:absolute;bottom:-10px;right:14px;width:0;height:0;border:5px solid transparent;border-top-color:var(--purple)}
.mascot-bubble-inner{display:flex;align-items:flex-start;gap:6px}
.mascot-typing{display:inline-flex;gap:3px;align-items:center;min-height:16px}
.mascot-typing span{width:5px;height:5px;border-radius:50%;background:var(--purple);animation:typing 1.2s ease infinite}
.mascot-typing span:nth-child(2){animation-delay:.2s}
.mascot-typing span:nth-child(3){animation-delay:.4s}
.mascot-img{width:56px;height:56px;object-fit:contain;pointer-events:auto;cursor:pointer;filter:drop-shadow(0 4px 12px rgba(124,58,237,.3));animation:mascotFloat 3s ease-in-out infinite;flex-shrink:0}
.mascot-img:hover{animation-play-state:paused;transform:scale(1.12)}

/* â”€â”€ LOGO STAMP â€” inline in navbars â”€â”€ */
.logo-stamp{display:inline-flex;align-items:center;gap:7px}
.logo-stamp img{width:28px;height:28px;object-fit:contain;border-radius:7px;animation:logoEntrance .5s ease}
.logo-stamp-sm img{width:22px;height:22px}

/* â”€â”€ PAGE LOGO BADGE â€” shown on key pages â”€â”€ */
.page-brain-badge{display:flex;flex-direction:column;align-items:center;gap:4px;padding:16px 0 8px}
.page-brain-badge img{animation:brainBounce 2s ease-in-out infinite}
.page-brain-badge.hw img{animation:brainRead 2.5s ease-in-out infinite}
.page-brain-badge.idea img{animation:brainIdea 1.8s ease-in-out infinite}
.page-brain-badge.cheer img{animation:brainCheer 1.5s ease-in-out infinite}
.page-brain-badge p{font-size:.72rem;font-weight:700;color:var(--purple);letter-spacing:.04em;text-transform:uppercase}

/* â”€â”€ LAYOUT â”€â”€ */
#app{min-height:100vh}
.page{display:none;min-height:100vh;flex-direction:column;animation:fadeIn .25s ease}
.page.active{display:flex}
.container{max-width:480px;margin:0 auto;padding:0 20px;width:100%}

/* â”€â”€ SPLASH â”€â”€ */
#splash{position:fixed;inset:0;background:var(--white);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s}
#splash.hide{opacity:0;pointer-events:none}
.splash-logo{font-size:2rem;font-weight:800;color:var(--blue);letter-spacing:-1px;animation:pop .5s ease}
.splash-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--blue);animation:pulse 1s ease infinite;margin:20px 4px 0}
.splash-dot:nth-child(2){animation-delay:.15s}.splash-dot:nth-child(3){animation-delay:.3s}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--white);padding:10px 20px;border-radius:50px;font-size:.8rem;font-weight:500;z-index:9000;white-space:nowrap;max-width:90vw;animation:toastIn .25s ease}
#toast.out{animation:toastOut .25s ease forwards}

/* â”€â”€ NAV â”€â”€ */
.topnav{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.logo{font-size:1.2rem;font-weight:800;color:var(--blue);letter-spacing:-.5px;cursor:pointer}
.logo span{color:var(--text)}
.nav-right{display:flex;align-items:center;gap:8px}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom);z-index:100}
.bnav-btn{flex:1;background:none;border:none;color:var(--subtle);padding:10px 4px 8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;font-family:'Poppins',sans-serif;font-size:.6rem;font-weight:500;transition:color .15s}
.bnav-btn.active{color:var(--blue)}
.bnav-btn svg{width:22px;height:22px;transition:transform .15s}
.bnav-btn.active svg{transform:translateY(-2px)}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:12px;border:none;cursor:pointer;font-family:'Poppins',sans-serif;font-weight:600;font-size:.875rem;transition:all .15s}
.btn-primary{background:var(--blue);color:var(--white)}
.btn-primary:hover{background:var(--blue-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3)}
.btn-secondary{background:var(--blue-light);color:var(--blue)}
.btn-secondary:hover{background:var(--blue-mid)}
.btn-outline{background:transparent;color:var(--blue);border:1.5px solid var(--blue)}
.btn-outline:hover{background:var(--blue-light)}
.btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue)}
.btn-purple{background:var(--purple);color:var(--white)}
.btn-purple:hover{background:#6D28D9;transform:translateY(-1px)}
.btn-green{background:var(--green);color:var(--white)}
.btn-sm{padding:8px 14px;font-size:.8rem;border-radius:10px}
.btn-full{width:100%}
.btn-icon{width:40px;height:40px;padding:0;border-radius:10px}
.btn[disabled]{opacity:.5;pointer-events:none}

/* â”€â”€ INPUTS â”€â”€ */
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:18px}
.form-label{font-size:.75rem;font-weight:600;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
.form-input{background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:13px 16px;color:var(--text);font-family:'Poppins',sans-serif;font-size:.9rem;outline:none;transition:border-color .15s,box-shadow .15s;width:100%}
.form-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--white)}
.form-input.error{border-color:var(--red);animation:shake .35s ease}
.form-input::placeholder{color:var(--subtle)}
select.form-input{cursor:pointer}
textarea.form-input{resize:vertical;min-height:90px}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:20px;box-shadow:var(--shadow)}
.card-elevated{box-shadow:var(--shadow-md)}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:50px;font-size:.7rem;font-weight:600}
.badge-blue{background:var(--blue-light);color:var(--blue)}
.badge-green{background:#ECFDF5;color:var(--green)}
.badge-gold{background:#FFFBEB;color:var(--gold)}
.badge-purple{background:#F5F3FF;color:var(--purple)}
.badge-red{background:#FEF2F2;color:var(--red)}
.badge-orange{background:#FFF7ED;color:var(--orange)}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-track{background:var(--border);border-radius:50px;overflow:hidden}
.prog-bar{background:linear-gradient(90deg,var(--blue),var(--purple));border-radius:50px;transition:width .8s cubic-bezier(.4,0,.2,1);height:100%}
.prog-sm{height:6px}.prog-md{height:8px}.prog-lg{height:12px}

/* â”€â”€ AVATAR â”€â”€ */
.avatar{border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--white);flex-shrink:0;font-family:'Poppins',sans-serif}
.avatar-sm{width:36px;height:36px;font-size:.8rem}
.avatar-md{width:48px;height:48px;font-size:1rem}
.avatar-lg{width:64px;height:64px;font-size:1.3rem}

/* â”€â”€ STRENGTH METER â”€â”€ */
.strength-bars{display:flex;gap:4px;margin-top:8px}
.strength-bar{height:4px;flex:1;border-radius:50px;background:var(--border);transition:background .3s}

/* â”€â”€ LOADER â”€â”€ */
.loader{display:flex;gap:6px;align-items:center;justify-content:center;padding:32px}
.loader-dot{width:8px;height:8px;border-radius:50%;background:var(--blue);animation:pulse 1.2s ease infinite}
.loader-dot:nth-child(2){animation-delay:.15s;background:var(--purple)}
.loader-dot:nth-child(3){animation-delay:.3s;background:var(--gold)}

/* â”€â”€ XP BURST â”€â”€ */
.xp-burst{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:800;color:var(--blue);pointer-events:none;z-index:999;animation:xpBurst .7s ease forwards}
.confetti-piece{position:fixed;width:8px;height:14px;border-radius:3px;pointer-events:none;z-index:9998;animation:confettiFall linear forwards}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero{background:linear-gradient(160deg,var(--blue) 0%,#1E40AF 40%,#312E81 100%);color:var(--white);padding:60px 20px 48px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
.hero-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:50px;padding:6px 14px;font-size:.75rem;font-weight:600;margin-bottom:24px}
.hero h1{font-size:clamp(2rem,7vw,2.8rem);font-weight:800;line-height:1.15;margin-bottom:16px;letter-spacing:-1px}
.hero h1 em{font-style:normal;color:#93C5FD}
.hero p{font-size:.95rem;opacity:.85;line-height:1.7;max-width:380px;margin:0 auto 32px}
.hero-ctas{display:flex;flex-direction:column;gap:10px;max-width:300px;margin:0 auto}
.hero-ctas .btn{padding:15px 20px;font-size:.95rem;border-radius:14px}
.btn-white{background:var(--white);color:var(--blue)}.btn-white:hover{background:var(--blue-light)}
.btn-white-outline{background:transparent;color:var(--white);border:1.5px solid rgba(255,255,255,.4)}.btn-white-outline:hover{background:rgba(255,255,255,.1)}
.stats-strip{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border)}
.stat-block{background:var(--white);padding:20px 12px;text-align:center}
.stat-num{font-size:1.5rem;font-weight:800;color:var(--blue)}
.stat-lbl{font-size:.7rem;color:var(--muted);font-weight:500;margin-top:2px}
.landing-section{padding:32px 20px;background:var(--white);border-bottom:1px solid var(--border)}
.section-title{font-size:1.2rem;font-weight:700;margin-bottom:20px;letter-spacing:-.5px}
.feature-card{display:flex;gap:14px;align-items:flex-start;padding:16px;border:1.5px solid var(--border);border-radius:14px;margin-bottom:10px;transition:all .15s;cursor:default}
.feature-card:hover{border-color:var(--blue);background:var(--blue-light)}
.feature-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.feature-card h4{font-size:.9rem;font-weight:600;margin-bottom:4px}
.feature-card p{font-size:.8rem;color:var(--muted);line-height:1.5}

/* â”€â”€ MASCOT HERO â”€â”€ */
.hero-mascot-wrap{margin-bottom:20px;position:relative;display:inline-block}
.hero-mascot{width:100px;height:100px;object-fit:contain;filter:drop-shadow(0 8px 24px rgba(0,0,0,.35));animation:mascotFloat 3s ease-in-out infinite}
@keyframes mascotFloat{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-12px) rotate(2deg)}}

/* â”€â”€ MASCOT FEATURE CARDS â”€â”€ */
.mascot-feature-card{display:flex;align-items:center;gap:0;background:var(--white);border:1.5px solid var(--border);border-radius:18px;margin-bottom:12px;overflow:hidden;cursor:pointer;transition:all .2s;box-shadow:var(--shadow)}
.mascot-feature-card:hover{border-color:var(--purple);box-shadow:0 8px 32px rgba(124,58,237,.15);transform:translateY(-2px)}
.mfc-img-wrap{width:110px;flex-shrink:0;background:linear-gradient(135deg,#F5F3FF,#EDE9FE);display:flex;align-items:center;justify-content:center;padding:10px 4px;min-height:120px;position:relative;overflow:hidden}
.mfc-img{width:95px;height:95px;object-fit:contain;transition:transform .3s}
.mascot-feature-card:hover .mfc-img{transform:scale(1.08)}
.mfc-body{flex:1;padding:16px 16px 16px 12px}
.mfc-body h4{font-size:.92rem;font-weight:700;color:var(--text);margin-bottom:5px;letter-spacing:-.2px}
.mfc-body p{font-size:.78rem;color:var(--muted);line-height:1.55;margin-bottom:8px}
.mfc-cta{font-size:.75rem;font-weight:700;color:var(--purple);letter-spacing:.02em}

/* Per-mascot animations */
@keyframes brainBounce{0%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}60%{transform:translateY(-3px)}}
@keyframes brainRead{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-4deg)}75%{transform:rotate(4deg)}}
@keyframes brainIdea{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes brainCheer{0%,100%{transform:translateY(0) scale(1)}33%{transform:translateY(-6px) scale(1.04)}66%{transform:translateY(-3px) scale(1.02)}}
.mfc-bounce{animation:brainBounce 2s ease-in-out infinite}
.mfc-read{animation:brainRead 2.5s ease-in-out infinite}
.mfc-idea{animation:brainIdea 1.8s ease-in-out infinite}
.mfc-cheer{animation:brainCheer 1.5s ease-in-out infinite}

/* Pause animation on hover for clarity */
.mascot-feature-card:hover .mfc-bounce,
.mascot-feature-card:hover .mfc-read,
.mascot-feature-card:hover .mfc-idea,
.mascot-feature-card:hover .mfc-cheer{animation-play-state:paused}

/* â”€â”€ LOGO IMG (inline in navbars) â”€â”€ */
.logo-img{width:28px;height:28px;object-fit:contain;flex-shrink:0;border-radius:6px}
.logo-img-sm{width:22px;height:22px;object-fit:contain;flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.auth-header{background:var(--blue);padding:32px 20px 28px;color:var(--white);text-align:center}
.auth-header h2{font-size:1.5rem;font-weight:700;margin-bottom:4px;letter-spacing:-.5px}
.auth-header p{font-size:.85rem;opacity:.8}
.auth-body{flex:1;padding:24px 20px 100px;background:var(--bg)}
.auth-link{text-align:center;font-size:.85rem;color:var(--muted);margin-top:20px}
.auth-link a{color:var(--blue);font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-body{flex:1;padding:20px 20px 90px;background:var(--bg);display:flex;flex-direction:column;gap:16px}
.welcome-card{background:linear-gradient(135deg,var(--blue),#7C3AED);color:var(--white);border-radius:var(--r);padding:22px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(37,99,235,.25);animation:fadeUp .4s ease}
.welcome-right{text-align:right}
.xp-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.2);border-radius:50px;padding:4px 10px;font-size:.75rem;font-weight:700;margin-top:6px;border:1px solid rgba(255,255,255,.3)}
.rank-progress-card{animation:fadeUp .4s .05s both}
.rank-progress-card .rp-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.rank-label{font-size:.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;animation:fadeUp .4s .1s both}
.stats-grid .card{padding:16px;text-align:center}
.stats-grid .s-num{font-size:1.6rem;font-weight:800;letter-spacing:-1px}
.stats-grid .s-lbl{font-size:.7rem;color:var(--muted);font-weight:500;margin-top:2px}
.quick-actions{animation:fadeUp .4s .15s both}
.quick-actions h3{font-size:.85rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px}
.action-btn{display:flex;align-items:center;gap:12px;width:100%;background:var(--white);border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;cursor:pointer;font-family:'Poppins',sans-serif;text-align:left;transition:all .15s;margin-bottom:8px}
.action-btn:hover{border-color:var(--blue);background:var(--blue-light)}
.action-btn .ab-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.action-btn .ab-text strong{display:block;font-size:.875rem;font-weight:600;color:var(--text)}
.action-btn .ab-text span{font-size:.75rem;color:var(--muted)}
.action-btn svg.arrow{width:16px;height:16px;color:var(--subtle);margin-left:auto}

/* â”€â”€ Due for review banner â”€â”€ */
.review-banner{background:linear-gradient(135deg,#FFFBEB,#FEF3C7);border:1.5px solid #FDE68A;border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:transform .15s}
.review-banner:hover{transform:translateY(-1px)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header{background:var(--white);border-bottom:1px solid var(--border);padding:20px}
.page-header h2{font-size:1.2rem;font-weight:700;letter-spacing:-.3px}
.page-header p{font-size:.8rem;color:var(--muted);margin-top:4px}
.upload-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:40px}
.drop-zone{border:2px dashed var(--border);border-radius:var(--r);padding:40px 20px;text-align:center;cursor:pointer;transition:all .15s;position:relative;background:var(--white)}
.drop-zone:hover,.drop-zone.drag{border-color:var(--blue);background:var(--blue-light)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.drop-icon{width:52px;height:52px;border-radius:14px;background:var(--blue-light);display:flex;align-items:center;justify-content:center;margin:0 auto 14px;animation:float 3s ease-in-out infinite}
.drop-zone h4{font-size:.95rem;font-weight:600;margin-bottom:4px}
.drop-zone p{font-size:.8rem;color:var(--muted)}
.file-pill{display:flex;align-items:center;gap:10px;background:var(--white);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:.82rem}
.file-pill .fp-name{flex:1;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-pill .fp-size{color:var(--subtle);flex-shrink:0}
.file-pill .fp-rm{background:none;border:none;color:var(--subtle);cursor:pointer;padding:2px;border-radius:4px;display:flex}
.file-pill .fp-rm:hover{color:var(--red)}
.gen-status{display:flex;flex-direction:column;align-items:center;gap:12px;padding:32px 20px;text-align:center}
.gen-status p{font-size:.85rem;color:var(--muted)}

/* Output type selector */
.output-tabs{display:flex;gap:6px;margin-bottom:16px}
.output-tab{flex:1;padding:10px 8px;border:1.5px solid var(--border);border-radius:10px;background:var(--white);cursor:pointer;font-family:'Poppins',sans-serif;font-size:.78rem;font-weight:600;color:var(--muted);text-align:center;transition:all .15s}
.output-tab.active{border-color:var(--blue);color:var(--blue);background:var(--blue-light)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quiz-header{background:var(--white);border-bottom:1px solid var(--border);padding:16px 20px}
.quiz-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.quiz-timer{font-size:.8rem;font-weight:700;color:var(--blue);background:var(--blue-light);padding:4px 12px;border-radius:50px}
.quiz-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:40px}
.question-card{background:var(--white);border-radius:var(--r);padding:22px;box-shadow:var(--shadow-md);animation:fadeUp .3s ease}
.question-num{font-size:.7rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}
.question-text{font-size:1.05rem;font-weight:600;line-height:1.5;letter-spacing:-.2px}
.options-list{display:flex;flex-direction:column;gap:8px}
.option-btn{display:flex;align-items:center;gap:12px;width:100%;background:var(--white);border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;cursor:pointer;font-family:'Poppins',sans-serif;text-align:left;transition:all .15s}
.option-btn:hover:not(.locked){border-color:var(--blue);background:var(--blue-light)}
.option-btn.correct{border-color:var(--green)!important;background:#ECFDF5!important}
.option-btn.wrong{border-color:var(--red)!important;background:#FEF2F2!important;animation:shake .35s ease}
.option-btn.locked{pointer-events:none}
.option-letter{width:30px;height:30px;border-radius:8px;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0;transition:all .15s}
.option-btn.correct .option-letter{background:var(--green);border-color:var(--green);color:var(--white)}
.option-btn.wrong .option-letter{background:var(--red);border-color:var(--red);color:var(--white)}
.option-text{font-size:.875rem;font-weight:500;line-height:1.4}
.explanation-card{background:var(--blue-light);border:1.5px solid var(--blue-mid);border-radius:12px;padding:16px;animation:fadeUp .25s ease}
.explanation-card p{font-size:.85rem;line-height:1.6;color:var(--text)}

/* ELI5 toggle */
.eli5-toggle{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--white);border:1.5px solid var(--border);border-radius:10px;cursor:pointer;font-size:.8rem;font-weight:600;color:var(--muted);transition:all .15s}
.eli5-toggle.on{border-color:var(--purple);color:var(--purple);background:#F5F3FF}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.score-body{flex:1;padding:32px 20px 96px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);text-align:center;gap:20px;color:var(--text)}
.score-ring{width:140px;height:140px;border-radius:50%;border:8px solid var(--blue-mid);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;animation:pop .5s ease}
.score-ring::after{content:'';position:absolute;inset:-8px;border-radius:50%;border:8px solid transparent;border-top-color:var(--blue);animation:spin 1.5s linear infinite}
.score-pct{font-size:2.8rem;font-weight:800;color:var(--blue);line-height:1;letter-spacing:-2px}
.score-label{font-size:.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
.score-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:360px}
.score-stat{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px 8px;text-align:center}
.score-stat-num{font-size:1.3rem;font-weight:800;letter-spacing:-.5px}
.score-stat-lbl{font-size:.68rem;color:var(--muted);font-weight:500}
.score-actions{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px}
.score-actions .btn{padding:14px;font-size:.9rem}
.score-ring.done::after{animation:none;opacity:.3}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOMEWORK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hw-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:40px}
.hw-drop{border:2px dashed var(--border);border-radius:var(--r);padding:40px 20px;text-align:center;cursor:pointer;background:var(--white);position:relative;transition:all .15s}
.hw-drop:hover,.hw-drop.drag{border-color:var(--purple);background:#F5F3FF}
.hw-drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
.hw-img-preview{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:var(--bg)}
.hw-img-preview img{width:100%;max-height:280px;object-fit:contain;display:block}
.step-block{border-left:3px solid var(--blue);padding:10px 0 10px 16px;margin:8px 0}
.step-block:nth-child(2){border-color:var(--purple)}
.step-block:nth-child(3){border-color:var(--green)}
.step-block:nth-child(4){border-color:var(--gold)}
.step-block h5{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;color:var(--blue)}
.step-block p{font-size:.85rem;line-height:1.6;color:var(--text)}

/* Camera mode */
.camera-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;aspect-ratio:4/3}
#cameraVideo{width:100%;height:100%;object-fit:cover;display:block}
.camera-controls{display:flex;gap:10px;justify-content:center;margin-top:12px}

/* Feedback result */
.feedback-correct{background:#ECFDF5;border:1.5px solid #A7F3D0;border-radius:12px;padding:16px}
.feedback-wrong{background:#FEF2F2;border:1.5px solid #FECACA;border-radius:12px;padding:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lb-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:90px}
.my-rank-card{background:linear-gradient(135deg,var(--blue),#7C3AED);color:var(--white);border-radius:var(--r);padding:20px;text-align:center;animation:rankGlow 2s ease-in-out infinite}
.my-rank-card .rank-num{font-size:2.5rem;font-weight:800;letter-spacing:-2px}
.my-rank-card .rank-sub{font-size:.8rem;opacity:.85;margin-top:2px}
.tab-strip{display:flex;gap:4px;background:var(--white);border-radius:12px;padding:4px;border:1px solid var(--border)}
.tab-btn{flex:1;background:none;border:none;border-radius:10px;padding:8px;font-family:'Poppins',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;color:var(--muted);transition:all .15s}
.tab-btn.active{background:var(--blue);color:var(--white)}
.lb-list{display:flex;flex-direction:column;gap:6px}
.lb-row{display:flex;align-items:center;gap:12px;background:var(--white);border:1px solid var(--border);border-radius:12px;padding:12px 14px;transition:border-color .15s}
.lb-row.lb-me{border-color:var(--blue);background:var(--blue-light)}
.lb-pos{width:28px;text-align:center;font-weight:800;font-size:.9rem;flex-shrink:0}
.lb-pos.gold{color:var(--gold)}.lb-pos.silver{color:#94A3B8}.lb-pos.bronze{color:#CD7F32}
.lb-info{flex:1;min-width:0}
.lb-name{font-size:.875rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-sub{font-size:.7rem;color:var(--muted);font-weight:500}
.lb-xp{font-weight:700;font-size:.85rem;color:var(--blue);flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYTICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.analytics-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:90px}
.heatmap-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.heat-cell{aspect-ratio:1;border-radius:4px;background:var(--border);transition:background .3s;cursor:default;position:relative}
.heat-cell:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--text);color:var(--white);padding:4px 8px;border-radius:6px;font-size:.65rem;white-space:nowrap;z-index:10}
.heat-cell.l1{background:#DBEAFE}
.heat-cell.l2{background:#93C5FD}
.heat-cell.l3{background:#3B82F6}
.heat-cell.l4{background:#1D4ED8}
.topic-bar-wrap{display:flex;flex-direction:column;gap:8px}
.topic-bar-row{display:flex;align-items:center;gap:10px}
.topic-bar-label{font-size:.75rem;font-weight:500;color:var(--text);width:100px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.topic-bar-track{flex:1;background:var(--border);border-radius:50px;height:8px;overflow:hidden}
.topic-bar-fill{height:100%;border-radius:50px;transition:width 1s cubic-bezier(.4,0,.2,1)}
.topic-bar-pct{font-size:.72rem;font-weight:700;width:32px;text-align:right;flex-shrink:0}
.analytics-summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.summary-tile{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.summary-tile .st-num{font-size:1.8rem;font-weight:800;letter-spacing:-1px}
.summary-tile .st-lbl{font-size:.7rem;color:var(--muted);font-weight:500;margin-top:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUMMARY / NOTES PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.summary-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:40px}
.mind-map-canvas{width:100%;min-height:260px;background:var(--white);border:1px solid var(--border);border-radius:var(--r);position:relative;overflow:hidden}
.mm-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--blue);color:var(--white);padding:10px 18px;border-radius:50px;font-size:.8rem;font-weight:700;text-align:center;max-width:120px;z-index:2}
.mm-branch{position:absolute;background:var(--bg);border:2px solid var(--blue-mid);border-radius:10px;padding:6px 10px;font-size:.7rem;font-weight:600;color:var(--text);z-index:2;max-width:100px;text-align:center;cursor:default;transition:border-color .15s}
.mm-branch:hover{border-color:var(--blue);background:var(--blue-light)}
.mm-child{position:absolute;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:.65rem;color:var(--muted);z-index:1;max-width:90px;text-align:center}
.key-point-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.key-point-item:last-child{border-bottom:none}
.kp-num{width:24px;height:24px;border-radius:50%;background:var(--blue-light);color:var(--blue);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;flex-shrink:0}
.kp-text{font-size:.85rem;line-height:1.5;flex:1}

/* Simulation container */
.sim-container{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:20px;min-height:200px;overflow:hidden}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-body{flex:1;padding:20px;background:var(--bg);display:flex;flex-direction:column;gap:16px;padding-bottom:90px}
.settings-section{display:flex;flex-direction:column;gap:8px}
.settings-label{font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:0 4px}
.settings-row{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:border-color .15s}
.settings-row:hover{border-color:var(--blue)}
.settings-row .sr-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.settings-row .sr-info{flex:1}
.settings-row .sr-title{font-size:.875rem;font-weight:600}
.settings-row .sr-sub{font-size:.75rem;color:var(--muted)}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <img src="/static/logo.png" alt="Brainliant" style="width:90px;height:90px;object-fit:contain;animation:mascotFloat 3s ease-in-out infinite;filter:drop-shadow(0 6px 18px rgba(124,58,237,.3))">
  <div class="splash-logo" style="margin-top:12px">Brainliant</div>
  <div style="display:flex;gap:6px;margin-top:14px">
    <div class="splash-dot"></div><div class="splash-dot"></div><div class="splash-dot"></div>
  </div>
</div>


<!-- â•â•â•â• MASCOT COMPANION (persistent) â•â•â•â• -->
<div id="mascot-companion" class="hidden">
  <div class="mascot-bubble" id="mascot-bubble" style="display:none">
    <div class="mascot-bubble-inner">
      <div id="mascot-msg">
        <div class="mascot-typing"><span></span><span></span><span></span></div>
      </div>
    </div>
  </div>
  <img src="/static/logo.png" alt="Brainy" class="mascot-img" id="mascot-img" onclick="toggleMascotBubble()" title="Brainy says hi!">
</div>

<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-landing" class="page">
  <div class="hero">
    <!-- Floating mascot logo -->
    <div class="hero-mascot-wrap">
      <img src="/static/logo.png" alt="Brainliant mascot" class="hero-mascot">
    </div>
    <div class="hero-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Powered by Cohere AI</div>
    <h1>Turn Any File Into<br><em>Interactive Mastery.</em></h1>
    <p>Upload textbooks, notes, or homework photos. Brainliant converts them into adaptive quizzes, smart notes, and step-by-step explanations.</p>
    <div class="hero-ctas">
      <button class="btn btn-white" onclick="go('signup')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Start Learning Free</button>
      <button class="btn btn-white-outline" onclick="demoQuiz()">See Demo Quiz</button>
    </div>
  </div>
  <div class="stats-strip">
    <div class="stat-block"><div class="stat-num" id="ls-users">â€”</div><div class="stat-lbl">Learners</div></div>
    <div class="stat-block"><div class="stat-num" id="ls-q">â€”</div><div class="stat-lbl">Quizzes</div></div>
    <div class="stat-block"><div class="stat-num" id="ls-f">â€”</div><div class="stat-lbl">Files</div></div>
  </div>
  <div class="landing-section">
    <p class="section-title">Everything to master anything</p>

    <!-- Quiz card -->
    <div class="mascot-feature-card" onclick="go('signup')">
      <div class="mfc-img-wrap">
        <img src="/static/brain_quiz.png" alt="Quizzes" class="mfc-img mfc-bounce">
      </div>
      <div class="mfc-body">
        <h4>Adaptive AI Quizzes</h4>
        <p>AI learns your weak topics and biases every quiz to fix them. Upload any file â€” instant questions.</p>
        <span class="mfc-cta">Try it â†’</span>
      </div>
    </div>

    <!-- Homework card -->
    <div class="mascot-feature-card" onclick="go('signup')">
      <div class="mfc-img-wrap">
        <img src="/static/brain_homework.png" alt="Homework" class="mfc-img mfc-read">
      </div>
      <div class="mfc-body">
        <h4>Homework AI</h4>
        <p>Photo of any problem â€” math, science, history. Get step-by-step explanation + check your own answer.</p>
        <span class="mfc-cta">Try it â†’</span>
      </div>
    </div>

    <!-- Explanation card -->
    <div class="mascot-feature-card" onclick="go('signup')">
      <div class="mfc-img-wrap">
        <img src="/static/brain_explanation.png" alt="Explanation" class="mfc-img mfc-idea">
      </div>
      <div class="mfc-body">
        <h4>Smart Notes & ELI5</h4>
        <p>Upload a 200-page PDF â€” get a mind map, key points, and formulas. Toggle "Explain Like I'm 5" anytime.</p>
        <span class="mfc-cta">Try it â†’</span>
      </div>
    </div>

    <!-- Leaderboard card -->
    <div class="mascot-feature-card" onclick="go('signup')">
      <div class="mfc-img-wrap">
        <img src="/static/brain_leaderboard.png" alt="Leaderboard" class="mfc-img mfc-cheer">
      </div>
      <div class="mfc-body">
        <h4>Rank, XP & Leaderboard</h4>
        <p>Earn XP for every quiz, climb from Beginner to Legend, track mastery heatmaps and compete globally.</p>
        <span class="mfc-cta">Try it â†’</span>
      </div>
    </div>

  </div>
  <div style="padding:20px;background:var(--white)">
    <button class="btn btn-primary btn-full" style="padding:16px;font-size:.95rem" onclick="go('signup')">Create Free Account</button>
    <button class="btn btn-ghost btn-full" style="padding:14px;margin-top:10px" onclick="go('signin')">Sign In</button>
    <p style="font-size:.72rem;color:var(--subtle);text-align:center;margin-top:16px"><a href="/terms" target="_blank" style="color:var(--muted);font-weight:600">Terms of Service</a> &nbsp;Â·&nbsp; <a href="/privacy" target="_blank" style="color:var(--muted);font-weight:600">Privacy Policy</a></p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SIGN UP â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-signup" class="page">
  <div class="auth-header"><div class="logo" style="color:white;margin-bottom:12px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px" onclick="go('landing')"><img src="/static/logo.png" class="logo-img" style="filter:drop-shadow(0 0 4px rgba(255,255,255,.6))" alt="">Brainliant</div><h2>Create Account</h2><p>Start your mastery journey today.</p></div>
  <div class="auth-body"><div class="container">
    <div class="form-group"><label class="form-label">Full Name</label><input id="su-name" class="form-input" type="text" placeholder="Alex Chen"></div>
    <div class="form-group"><label class="form-label">Username</label><input id="su-user" class="form-input" type="text" placeholder="alexchen"></div>
    <div class="form-group"><label class="form-label">Email</label><input id="su-email" class="form-input" type="email" placeholder="alex@email.com"></div>
    <div class="form-group"><label class="form-label">Password</label><input id="su-pass" class="form-input" type="password" placeholder="Min 8 characters" oninput="pwStrength(this.value)"><div class="strength-bars"><div id="sb1" class="strength-bar"></div><div id="sb2" class="strength-bar"></div><div id="sb3" class="strength-bar"></div><div id="sb4" class="strength-bar"></div></div></div>
    <div class="form-group"><label class="form-label">Confirm Password</label><input id="su-conf" class="form-input" type="password" placeholder="Repeat password"></div>
    <button id="su-btn" class="btn btn-primary btn-full" style="padding:15px" onclick="doRegister()">Create Account</button>
    <p class="auth-link">Already have an account? <a href="#" onclick="go('signin')">Sign In</a></p>
    <p style="font-size:.72rem;color:var(--subtle);text-align:center;margin-top:16px;line-height:1.6">By creating an account you agree to our<br><a href="/terms" target="_blank" style="color:var(--muted);font-weight:600">Terms of Service</a> &amp; <a href="/privacy" target="_blank" style="color:var(--muted);font-weight:600">Privacy Policy</a></p>
  </div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SIGN IN â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-signin" class="page">
  <div class="auth-header"><div class="logo" style="color:white;margin-bottom:12px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px" onclick="go('landing')"><img src="/static/logo.png" class="logo-img" style="filter:drop-shadow(0 0 4px rgba(255,255,255,.6))" alt="">Brainliant</div><h2>Welcome Back</h2><p>Sign in to continue learning.</p></div>
  <div class="auth-body"><div class="container">
    <div class="form-group"><label class="form-label">Email</label><input id="si-email" class="form-input" type="email" placeholder="alex@email.com"></div>
    <div class="form-group"><label class="form-label">Password</label><input id="si-pass" class="form-input" type="password" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <label style="display:flex;align-items:center;gap:7px;font-size:.82rem;cursor:pointer;color:var(--muted)"><input type="checkbox" id="si-rem" style="accent-color:var(--blue)"> Remember me</label>
      <a href="#" style="font-size:.82rem;color:var(--blue);font-weight:600">Forgot password?</a>
    </div>
    <button id="si-btn" class="btn btn-primary btn-full" style="padding:15px" onclick="doLogin()">Sign In</button>
    <p class="auth-link">New here? <a href="#" onclick="go('signup')">Create Account</a></p>
    <p style="font-size:.72rem;color:var(--subtle);text-align:center;margin-top:16px"><a href="/terms" target="_blank" style="color:var(--muted);font-weight:600">Terms</a> &nbsp;Â·&nbsp; <a href="/privacy" target="_blank" style="color:var(--muted);font-weight:600">Privacy</a></p>
  </div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-dashboard" class="page">
  <div class="topnav">
    <div class="logo" style="display:flex;align-items:center;gap:8px"><img src="/static/logo.png" class="logo-img" alt="">Brain<span>liant</span></div>
    <div class="nav-right">
      <button class="btn btn-ghost btn-sm btn-icon" onclick="go('settings')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
      <div class="avatar avatar-sm" id="d-avatar">A</div>
    </div>
  </div>
  <div class="dash-body">
    <div class="welcome-card">
      <div>
        <p style="font-size:.75rem;opacity:.8;font-weight:500">Good to see you,</p>
        <h2 id="d-name" style="font-size:1.3rem;font-weight:800;letter-spacing:-.5px">Learner</h2>
        <div class="xp-badge" id="d-xp-badge">âš¡ 0 XP</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <img src="/static/logo.png" style="width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 4px 12px rgba(0,0,0,.25));animation:mascotFloat 3s ease-in-out infinite">
        <span class="badge badge-gold" id="d-streak-badge-welcome" data-streak>ğŸ”¥ 1 day</span>
        <p id="d-rank-badge" style="font-size:.7rem;margin-top:2px;font-weight:700;opacity:.9">Beginner</p>
        <p id="d-level-badge" style="font-size:.65rem;opacity:.7">Level 1</p>
      </div>
    </div>
    <!-- Daily Streak Progress Card -->
    <div class="card" style="margin-bottom:14px;padding:16px 18px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:1.1rem">ğŸ”¥</span>
          <span style="font-size:.85rem;font-weight:700;color:var(--text)">Daily Streak</span>
        </div>
        <span id="d-streak-badge" data-streak style="font-size:.78rem;font-weight:700;background:#FFF7ED;color:#C2410C;padding:4px 10px;border-radius:20px">ğŸ”¥ 1 day</span>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <span id="streak-progress-label" style="font-size:.72rem;color:var(--muted)">0/5 activities today</span>
        <span style="font-size:.7rem;color:var(--muted)">5 to secure</span>
      </div>
      <div style="height:7px;background:var(--border);border-radius:8px;overflow:hidden">
        <div id="streak-progress-bar" style="height:100%;background:linear-gradient(90deg,#F97316,#EF4444);border-radius:8px;width:0%;transition:width .5s ease"></div>
      </div>
      <p style="font-size:.7rem;color:var(--subtle);margin-top:6px;text-align:center">Upload files, do homework, or complete quizzes to secure today's streak</p>
    </div>

    <!-- Review due banner -->
    <div class="review-banner" id="reviewBanner" style="display:none" onclick="startAdaptiveQuiz()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      <div style="flex:1"><strong style="font-size:.875rem;color:var(--text)">Topics due for review</strong><br><span id="dueCount" style="font-size:.75rem;color:var(--muted)">Tap to start adaptive quiz</span></div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
    </div>
    <div class="card rank-progress-card">
      <div class="rp-top">
        <div><div class="rank-label">Rank Progress</div><div id="rp-rank" style="font-size:.95rem;font-weight:700;margin-top:2px">Beginner</div></div>
        <div style="text-align:right"><div class="rank-label">Next</div><div id="rp-next" style="font-size:.85rem;font-weight:600;color:var(--blue);margin-top:2px">Explorer</div></div>
      </div>
      <div class="prog-track prog-md"><div class="prog-bar" id="rp-bar" style="width:0%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <span style="font-size:.7rem;color:var(--muted)" id="rp-xp-cur">0 XP</span>
        <span style="font-size:.7rem;color:var(--muted)" id="rp-xp-next">500 XP to Explorer</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="card"><div class="s-num" id="ds-rank" style="color:var(--blue)">#â€”</div><div class="s-lbl">Global Rank</div></div>
      <div class="card"><div class="s-num" id="ds-pct" style="color:var(--purple)">â€”%</div><div class="s-lbl">Percentile</div></div>
      <div class="card"><div class="s-num" id="ds-courses" style="color:var(--gold)">0</div><div class="s-lbl">Courses</div></div>
      <div class="card"><div class="s-num" id="ds-quizzes" style="color:var(--green)">0</div><div class="s-lbl">Quizzes</div></div>
    </div>
    <div class="quick-actions">
      <h3>Quick Actions</h3>
      <button class="action-btn" onclick="go('upload')"><div class="ab-icon" style="background:var(--blue-light)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg></div><div class="ab-text"><strong>Upload & Learn</strong><span>Quiz, notes or mind map from your file</span></div><svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
      <button class="action-btn" onclick="go('homework')"><div class="ab-icon" style="background:#F5F3FF"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg></div><div class="ab-text"><strong>Homework AI</strong><span>Upload a photo â€” explain + check your answer</span></div><svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
      <button class="action-btn" onclick="go('analytics')"><div class="ab-icon" style="background:#ECFDF5"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div><div class="ab-text"><strong>Analytics</strong><span>Mastery heatmap, weak topics, progress</span></div><svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
      <button class="action-btn" onclick="go('leaderboard')"><div class="ab-icon" style="background:#FFFBEB"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M5 3l14 9-14 9V3z"/></svg></div><div class="ab-text"><strong>Leaderboard</strong><span>See your global ranking</span></div><svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="bnav-btn active" onclick="go('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Home</button>
    <button class="bnav-btn" onclick="go('upload')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Upload</button>
    <button class="bnav-btn" onclick="go('homework')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>Homework</button>
    <button class="bnav-btn" onclick="go('analytics')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Stats</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• UPLOAD â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-upload" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('dashboard')">â† Back</button><span style="font-weight:700;font-size:.9rem">Upload & Learn</span><div style="width:60px"></div></div>
  <div class="page-header"><h2>Create Learning Content</h2><p>Upload your material and choose what to generate.</p></div>
  <div class="upload-body">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt,.md" onchange="handleFiles(this.files)">
      <div class="drop-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg></div>
      <h4>Drop files here or tap to browse</h4>
      <p>PDF, DOCX, TXT, MD</p>
    </div>
    <div id="fileList" style="display:flex;flex-direction:column;gap:8px"></div>
    <div id="uploadConfig" style="display:none">
      <div class="output-tabs">
        <div class="output-tab active" onclick="setOutputTab('quiz',this)">ğŸ“ Quiz</div>
        <div class="output-tab" onclick="setOutputTab('summary',this)">ğŸ“„ Notes</div>
        <div class="output-tab" onclick="setOutputTab('both',this)">âœ¨ Both</div>
      </div>
      <div class="form-group"><label class="form-label">Title (optional)</label><input id="cTitle" class="form-input" type="text" placeholder="e.g. Biology Chapter 3"></div>
      <div id="quizConfig">
        <div class="form-group"><label class="form-label">Difficulty</label><select id="cDiff" class="form-input"><option value="beginner">Beginner</option><option value="intermediate" selected>Intermediate</option><option value="advanced">Advanced</option></select></div>
        <div class="form-group"><label class="form-label">Number of Questions (5â€“30)</label><input id="qNum" class="form-input" type="number" value="10" min="5" max="30"></div>
      </div>
      <button class="btn btn-primary btn-full" style="padding:15px" onclick="generateContent()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Generate with Cohere AI</button>
    </div>
    <div id="genStatus" style="display:none">
      <div class="card gen-status">
        <div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div>
        <p id="genMsg">Reading your filesâ€¦</p>
        <div class="prog-track prog-md" style="width:100%;margin-top:8px"><div class="prog-bar" id="genBar" style="width:5%;transition:width .6s"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• QUIZ â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-quiz" class="page">
  <div class="quiz-header">
    <div class="quiz-meta">
      <button class="btn btn-ghost btn-sm" onclick="confirmExitQuiz()">Exit</button>
      <span id="quiz-name" style="font-size:.85rem;font-weight:600;color:var(--muted)">Quiz</span>
      <div class="quiz-timer" id="q-timer">00:00</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span style="font-size:.75rem;color:var(--muted)" id="q-prog-lbl">1/10</span>
      <div class="prog-track prog-sm" style="flex:1"><div class="prog-bar" id="q-prog-bar" style="width:10%"></div></div>
      <span class="badge badge-blue" id="q-xp-lbl">0 XP</span>
    </div>
  </div>
  <div class="quiz-body">
    <!-- ELI5 toggle -->
    <div style="display:flex;gap:8px;align-items:center">
      <button class="eli5-toggle" id="eli5Btn" onclick="toggleELI5()">ğŸ§’ ELI5 Mode</button>
      <span style="font-size:.72rem;color:var(--muted)">Explain Like I'm 5</span>
    </div>
    <div class="question-card">
      <div class="question-num" id="q-num">Question 1</div>
      <p class="question-text" id="q-text">Loadingâ€¦</p>
    </div>
    <div class="options-list" id="q-options"></div>
    <div id="q-exp" style="display:none" class="explanation-card"><p id="q-exp-text"></p></div>
    <div id="eli5-exp" style="display:none" class="card" style="border-color:var(--purple)"><p style="font-size:.85rem;color:var(--purple);font-weight:600;margin-bottom:6px">ğŸ§’ Simple Explanation</p><p id="eli5-text" style="font-size:.85rem;line-height:1.6"></p><div class="loader" id="eli5-loader" style="display:none;padding:12px"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div></div>
    <button id="q-next" class="btn btn-primary btn-full" style="padding:14px;display:none" onclick="nextQ()">Next Question â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SCORE â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-score" class="page">
  <div class="topnav"><div class="logo" style="display:flex;align-items:center;gap:8px"><img src="/static/logo.png" class="logo-img" alt="">Brain<span>liant</span></div></div>
  <div class="score-body">
    <div><h2 id="score-title" style="font-size:1.5rem;font-weight:800;letter-spacing:-.5px;margin-bottom:6px">Quiz Complete!</h2><p id="score-sub" style="color:var(--muted);font-size:.875rem">Here's how you did</p></div>
    <!-- Mascot reacts to score -->
    <img id="scoreMascot" src="/static/logo.png" style="width:80px;height:80px;object-fit:contain;filter:drop-shadow(0 6px 16px rgba(124,58,237,.3));animation:brainCheer 1.2s ease-in-out infinite">
    <div class="score-ring" id="scoreRing"><div class="score-pct" id="sc-pct">0%</div><div class="score-label">Score</div></div>
    <div class="score-stats">
      <div class="score-stat"><div class="score-stat-num" id="sc-xp" style="color:var(--blue)">+0</div><div class="score-stat-lbl">XP Earned</div></div>
      <div class="score-stat"><div class="score-stat-num" id="sc-cor" style="color:var(--green)">0/0</div><div class="score-stat-lbl">Correct</div></div>
      <div class="score-stat"><div class="score-stat-num" id="sc-streak" style="color:var(--gold)">ğŸ”¥1</div><div class="score-stat-lbl">Streak</div></div>
    </div>
    <!-- Weak topics from this quiz -->
    <div id="weakTopicsResult" style="width:100%;max-width:360px;display:none">
      <div class="card" style="text-align:left;padding:16px">
        <p style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Needs Practice</p>
        <div id="weakTopicsList" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
    </div>
    <div class="score-actions">
      <button class="btn btn-primary btn-full" onclick="retryQuiz()">Try Again</button>
      <button class="btn btn-secondary btn-full" onclick="startAdaptiveQuiz()">ğŸ¯ Adaptive Review</button>
      <button class="btn btn-ghost btn-full" onclick="go('dashboard')">Back to Dashboard</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HOMEWORK â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-homework" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('dashboard')">â† Back</button><div class="logo-stamp"><img src="/static/logo.png" alt=""><span style="font-weight:800;font-size:.95rem;color:var(--purple)">Homework AI</span></div><div style="width:60px"></div></div>
  <div class="page-brain-badge hw"><img src="/static/brain_homework.png" width="72" alt=""><p>Snap any problem â€” I will explain it</p></div>
  <div class="page-header"><h2>Homework AI</h2><p>Upload a photo or use camera â€” AI explains it and checks your answer.</p></div>
  <div class="hw-body">
    <!-- Mode selector -->
    <div class="tab-strip" style="margin-bottom:4px">
      <button class="tab-btn active" id="hw-tab-explain" onclick="setHWTab('explain')">ğŸ“– Explain</button>
      <button class="tab-btn" id="hw-tab-check" onclick="setHWTab('check')">âœ… Check My Answer</button>
    </div>

    <!-- Explain mode -->
    <div id="hw-explain-mode">
      <div class="hw-drop" id="hwDrop">
        <input type="file" id="hwInput" accept="image/*" onchange="handleHWImg(this)">
        <div class="drop-icon" style="background:#F5F3FF"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
        <h4>Upload homework photo</h4>
        <p>JPG, PNG, any image file</p>
      </div>
      <button class="btn btn-ghost btn-full btn-sm" style="margin-top:-8px" onclick="openCamera('explain')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Use Camera</button>
      <div id="cameraWrapExplain" style="display:none"><div class="camera-wrap"><video id="cameraVideoExplain" autoplay playsinline></video></div><div class="camera-controls"><button class="btn btn-primary btn-sm" onclick="captureCamera('explain')">ğŸ“¸ Capture</button><button class="btn btn-ghost btn-sm" onclick="closeCamera('explain')">Cancel</button></div></div>
      <div id="hwImgWrap" style="display:none" class="hw-img-preview"></div>
      <div id="hwForm" style="display:none">
        <div class="form-group"><label class="form-label">Describe the problem (improves AI accuracy)</label><textarea id="hwDesc" class="form-input" placeholder="e.g. Solve for x: 3x + 5 = 20"></textarea></div>
        <div class="form-group"><label class="form-label">Explanation Mode</label>
          <select id="hwMode" class="form-input">
            <option value="simple">ğŸ§’ ELI5 â€” Simple, like I'm 5</option>
            <option value="detailed" selected>ğŸ“– Detailed â€” Full breakdown</option>
            <option value="exam">ğŸ“ Exam-Ready â€” Formulas & tips</option>
          </select>
        </div>
        <button class="btn btn-purple btn-full" style="padding:14px" onclick="explainHW()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Explain with Cohere AI</button>
      </div>
      <div id="hwLoading" style="display:none"><div class="card"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div><p style="text-align:center;color:var(--muted);font-size:.85rem;padding-bottom:16px">Analysing your problemâ€¦</p></div></div>
      <div id="hwResult" style="display:none"></div>
    </div>

    <!-- Check answer mode -->
    <div id="hw-check-mode" style="display:none">
      <div class="form-group"><label class="form-label">Original Problem (describe it)</label><textarea id="ck-problem" class="form-input" placeholder="e.g. Find the area of a circle with radius 5cm"></textarea></div>
      <div class="form-group"><label class="form-label">Your Answer / Working</label><textarea id="ck-answer" class="form-input" placeholder="Write your answer or working hereâ€¦" rows="4"></textarea></div>
      <div style="margin-bottom:16px">
        <div class="hw-drop" id="ckDrop" style="padding:24px">
          <input type="file" id="ckInput" accept="image/*" onchange="handleCkImg(this)">
          <p style="font-size:.82rem;color:var(--muted)">ğŸ“¸ Or upload a photo of your written answer (optional)</p>
        </div>
        <div id="ckImgWrap" style="display:none;margin-top:8px" class="hw-img-preview"></div>
      </div>
      <button class="btn btn-green btn-full" style="padding:14px" onclick="checkSolution()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Check My Answer</button>
      <div id="ckLoading" style="display:none;margin-top:16px"><div class="card"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div><p style="text-align:center;color:var(--muted);font-size:.85rem;padding-bottom:16px">AI is checking your answerâ€¦</p></div></div>
      <div id="ckResult" style="display:none;margin-top:16px"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-analytics" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('dashboard')">â† Back</button><div class="logo-stamp"><img src="/static/logo.png" alt=""><span style="font-weight:800;font-size:.95rem;color:var(--blue)">Analytics</span></div><div style="width:60px"></div></div>
  <div class="page-brain-badge idea"><img src="/static/brain_explanation.png" width="64" alt=""><p>Your learning insights</p></div>
  <div class="analytics-body">
    <!-- Summary tiles -->
    <div class="analytics-summary-grid" id="analyticsTiles">
      <div class="summary-tile"><div class="st-num skeleton" style="height:36px;width:80px;margin:0 auto"></div><div class="st-lbl">Total XP</div></div>
      <div class="summary-tile"><div class="st-num skeleton" style="height:36px;width:60px;margin:0 auto"></div><div class="st-lbl">Avg Score</div></div>
      <div class="summary-tile"><div class="st-num skeleton" style="height:36px;width:70px;margin:0 auto"></div><div class="st-lbl">Study Time</div></div>
      <div class="summary-tile"><div class="st-num skeleton" style="height:36px;width:50px;margin:0 auto"></div><div class="st-lbl">Topics Tracked</div></div>
    </div>
    <!-- Heatmap -->
    <div class="card">
      <p style="font-size:.85rem;font-weight:700;margin-bottom:12px">ğŸ“… 30-Day Study Heatmap</p>
      <div class="heatmap-grid" id="heatmapGrid"></div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:10px;justify-content:flex-end">
        <span style="font-size:.65rem;color:var(--muted)">Less</span>
        <div style="width:10px;height:10px;border-radius:2px;background:var(--border)"></div>
        <div style="width:10px;height:10px;border-radius:2px;background:#DBEAFE"></div>
        <div style="width:10px;height:10px;border-radius:2px;background:#3B82F6"></div>
        <div style="width:10px;height:10px;border-radius:2px;background:#1D4ED8"></div>
        <span style="font-size:.65rem;color:var(--muted)">More</span>
      </div>
    </div>
    <!-- Topic mastery bars -->
    <div class="card">
      <p style="font-size:.85rem;font-weight:700;margin-bottom:16px">ğŸ§  Topic Mastery</p>
      <div id="topicBars"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div></div>
    </div>
    <!-- Weak topics -->
    <div class="card" id="weakCard" style="display:none">
      <p style="font-size:.85rem;font-weight:700;margin-bottom:12px">âš ï¸ Needs Practice</p>
      <div id="weakTopicsAnalytics" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
      <button class="btn btn-primary btn-full btn-sm" onclick="startAdaptiveQuiz()">ğŸ¯ Start Adaptive Quiz</button>
    </div>
    <!-- AI Simulation -->
    <div class="card">
      <p style="font-size:.85rem;font-weight:700;margin-bottom:10px">ğŸ”¬ Interactive Simulation</p>
      <div class="form-group" style="margin-bottom:10px"><input id="simConcept" class="form-input" type="text" placeholder="e.g. Newton's Laws, Photosynthesis, Quadratic Formula"></div>
      <button class="btn btn-purple btn-full btn-sm" onclick="generateSim()">Generate Interactive Demo</button>
      <div id="simLoading" style="display:none"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div></div>
      <div id="simResult" style="display:none;margin-top:12px"></div>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="bnav-btn" onclick="go('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Home</button>
    <button class="bnav-btn" onclick="go('upload')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Upload</button>
    <button class="bnav-btn" onclick="go('homework')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>Homework</button>
    <button class="bnav-btn active" onclick="go('analytics')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Stats</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SUMMARY / NOTES â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-summary" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('upload')">â† Back</button><span style="font-weight:700;font-size:.9rem">Smart Notes</span><button class="btn btn-ghost btn-sm" id="saveNotesBtn" onclick="saveNotesOffline()" style="display:none">ğŸ’¾ Save</button></div>
  <div class="summary-body" id="summaryBody">
    <div class="loader" style="padding:60px 0"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• LEADERBOARD â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-leaderboard" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('dashboard')">â† Back</button><div class="logo-stamp"><img src="/static/logo.png" alt=""><span style="font-weight:800;font-size:.95rem;color:var(--gold)">Leaderboard</span></div><div style="width:60px"></div></div>
  <div class="page-brain-badge cheer"><img src="/static/brain_leaderboard.png" width="64" alt=""><p>Global rankings</p></div>
  <div class="lb-body">
    <div class="my-rank-card"><p style="font-size:.7rem;opacity:.8;font-weight:600;text-transform:uppercase;letter-spacing:.1em">Your Global Rank</p><div class="rank-num" id="lb-my-rank">#â€”</div><p class="rank-sub" id="lb-my-sub">out of â€” users</p><div style="margin-top:10px"><span class="badge" style="background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.3)" id="lb-my-pct">Top â€”%</span></div></div>
    <div class="tab-strip"><button class="tab-btn active" id="tab-global" onclick="setTab('global')">Global Top 50</button><button class="tab-btn" id="tab-weekly" onclick="setTab('weekly')">This Week</button></div>
    <div class="lb-list" id="lbList"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div></div>
  </div>
  <div class="bottom-nav">
    <button class="bnav-btn" onclick="go('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Home</button>
    <button class="bnav-btn" onclick="go('upload')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Upload</button>
    <button class="bnav-btn" onclick="go('homework')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>Homework</button>
    <button class="bnav-btn active" onclick="go('leaderboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-14 9V3z"/></svg>Ranks</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â• -->
<div id="pg-settings" class="page">
  <div class="topnav"><button class="btn btn-ghost btn-sm" onclick="go('dashboard')">â† Back</button><span style="font-weight:700;font-size:.9rem">Settings</span><div style="width:60px"></div></div>
  <div class="settings-body">
    <div class="settings-section"><p class="settings-label">Account</p>
      <div class="card" style="display:flex;align-items:center;gap:14px;padding:18px">
        <div class="avatar avatar-lg" id="s-avatar">A</div>
        <div><div id="s-name" style="font-weight:700;font-size:1rem">Loadingâ€¦</div><div id="s-email" style="font-size:.8rem;color:var(--muted);margin-top:2px">â€”</div><div id="s-rank" class="badge badge-blue" style="margin-top:8px">Beginner</div></div>
      </div>
    </div>
    <div class="settings-section"><p class="settings-label">Actions</p>
      <button class="settings-row btn-full" style="text-align:left" onclick="doLogout()">
        <div class="sr-icon" style="background:#FEF2F2"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg></div>
        <div class="sr-info"><div class="sr-title" style="color:var(--red)">Sign Out</div><div class="sr-sub">Securely sign out of your account</div></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--subtle)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>
    <div class="settings-section"><p class="settings-label">Offline Quizzes</p>
      <div class="card"><p style="font-size:.8rem;font-weight:600;margin-bottom:12px">Saved for Offline</p><div id="savedQuizList"><div class="loader" style="padding:16px"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div></div></div>
    </div>
    <div class="settings-section"><p class="settings-label">About</p>
      <div class="card" style="text-align:center;padding:28px"><img src="/static/logo.png" style="width:64px;height:64px;object-fit:contain;margin-bottom:10px;filter:drop-shadow(0 4px 12px rgba(124,58,237,.25))"><div class="logo" style="font-size:1.4rem;margin-bottom:6px">Brainliant</div><p style="font-size:.75rem;color:var(--muted)">AI-Powered Learning Platform</p><p style="font-size:.7rem;color:var(--subtle);margin-top:4px">Powered by Cohere command-a-03-2025</p><div style="margin-top:16px;display:flex;justify-content:center;gap:16px"><a href="/terms" target="_blank" style="font-size:.72rem;color:var(--blue);font-weight:600;text-decoration:none">Terms of Service</a><a href="/privacy" target="_blank" style="font-size:.72rem;color:var(--blue);font-weight:600;text-decoration:none">Privacy Policy</a></div></div>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="bnav-btn" onclick="go('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Home</button>
    <button class="bnav-btn" onclick="go('upload')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Upload</button>
    <button class="bnav-btn" onclick="go('homework')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>Homework</button>
    <button class="bnav-btn" onclick="go('analytics')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Stats</button>
  </div>
</div>

</div><!-- #app -->

<!-- â•â•â•â•â•â•â•â•â•â• DAILY STREAK SECURED OVERLAY â•â•â•â•â•â•â•â•â•â• -->
<div id="daily-secured-overlay" style="
  display:none;position:fixed;inset:0;z-index:9999;
  background:#fff;
  flex-direction:column;align-items:center;justify-content:center;
  padding:40px 24px;text-align:center;">
  <img src="/static/logo.png" alt="Brainliant" style="
    width:96px;height:96px;object-fit:contain;margin-bottom:28px;
    filter:drop-shadow(0 6px 20px rgba(37,99,235,.22));
    animation:mascotFloat 3s ease-in-out infinite;">
  <div style="font-size:2.2rem;font-weight:900;letter-spacing:-.5px;color:#0F172A;line-height:1.1;margin-bottom:10px">
    Your daily streak<br>is secured!
  </div>
  <div style="font-size:1.05rem;color:#64748B;font-weight:500;margin-bottom:28px;line-height:1.5">
    Come back tomorrow to keep your streak alive.
  </div>
  <div id="dso-streak" style="
    background:linear-gradient(135deg,#F97316,#EF4444);
    color:#fff;font-size:1.1rem;font-weight:800;
    padding:12px 28px;border-radius:50px;letter-spacing:-.2px;
    margin-bottom:32px;box-shadow:0 4px 18px rgba(239,68,68,.28)">
    ğŸ”¥ <span id="dso-streak-num">1</span> Day Streak
  </div>
  <p style="font-size:.8rem;color:#94A3B8;margin-bottom:24px">
    You've completed all 5 activities for today. Great work!
  </p>
  <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px">
    <button onclick="closeDailySecured()" style="
      background:#2563EB;color:#fff;border:none;
      padding:14px 24px;border-radius:12px;font-size:.95rem;font-weight:700;
      cursor:pointer;font-family:inherit;">
      Continue Exploring
    </button>
    <button onclick="go('dashboard');closeDailySecured()" style="
      background:transparent;color:#64748B;border:1.5px solid #E2E8F0;
      padding:12px 24px;border-radius:12px;font-size:.88rem;font-weight:600;
      cursor:pointer;font-family:inherit;">
      Go to Dashboard
    </button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RANKS=['Beginner','Explorer','Scholar','Strategist','Master','Grandmaster','Legend'];
const RANK_XP=[0,500,1500,3500,7000,12000,20000];

let S={
  user:null, quiz:[], qIdx:0, score:0, xpEarned:0,
  timerInt:null, timerSec:0, quizStartTime:null,
  files:[], fileText:'', outputTab:'quiz',
  lbTab:'global', eli5:false,
  topicResults:[],
  cameraStream:null, cameraTarget:null,
  currentQuizTitle:'',
  // Daily activity tracking
  dailyStatus:{files_uploaded:0, hw_images:0, quizzes_done:0, total_today:0, streak_secured:false, daily_goal:5, streak:1}
};

// â”€â”€â”€ Daily streak helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDailyStatus(ds){
  if(!ds) return;
  S.dailyStatus={...S.dailyStatus,...ds};
  if(S.user) S.user.streak = ds.streak || S.user.streak;
  renderStreakProgress();
  if(ds.streak_secured && !S.dailyStatus._shownToday){
    S.dailyStatus._shownToday = true;
    setTimeout(()=>showDailySecured(), 800);
  }
}

function renderStreakProgress(){
  const ds = S.dailyStatus;
  const pct = Math.min(100, Math.round((ds.total_today||0) / (ds.daily_goal||5) * 100));
  // Update streak badge everywhere
  const streak = ds.streak || S.user?.streak || 1;
  document.querySelectorAll('[data-streak]').forEach(el => {
    el.textContent = 'ğŸ”¥ ' + streak + ' day' + (streak!==1?'s':'');
  });
  // Update progress bar if on dashboard
  const spBar = document.getElementById('streak-progress-bar');
  const spLbl = document.getElementById('streak-progress-label');
  if(spBar) spBar.style.width = pct + '%';
  if(spLbl) spLbl.textContent = (ds.total_today||0) + '/' + (ds.daily_goal||5) + ' activities today';
}

function showDailySecured(){
  const ov = document.getElementById('daily-secured-overlay');
  if(!ov) return;
  const streak = S.dailyStatus.streak || S.user?.streak || 1;
  const num = document.getElementById('dso-streak-num');
  if(num) num.textContent = streak;
  ov.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  // Update streak badge in overlay too
  if(S.user) setText('d-streak-badge', 'ğŸ”¥ '+streak+' day'+(streak!==1?'s':''));
}

function closeDailySecured(){
  const ov = document.getElementById('daily-secured-overlay');
  if(ov){ ov.style.display = 'none'; document.body.style.overflow = '';}
}

// Load daily status on init
async function loadDailyStatus(){
  if(!S.user) return;
  try{
    const r = await fetch('/user/daily-status', {credentials:'include'});
    if(r.ok){ const d = await r.json(); S.dailyStatus = {...S.dailyStatus,...d}; renderStreakProgress(); }
  }catch{}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el=document.getElementById('pg-'+page);
  if(el){el.classList.add('active');window.scrollTo(0,0)}
  if(page==='dashboard')refreshDash();
  if(page==='leaderboard')loadLeaderboard();
  if(page==='settings')refreshSettings();
  if(page==='analytics')loadAnalytics();
  // Show mascot on app pages, hide on auth/landing
  const hiddenPages=['landing','signup','signin'];
  const mc=document.getElementById('mascot-companion');
  if(mc){mc.classList.toggle('hidden',hiddenPages.includes(page))}
  mascotNotify(page);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  try{const r=await fetch('/stats');const d=await r.json();animCount('ls-users',d.users);animCount('ls-q',d.quizzes);animCount('ls-f',d.files)}catch{}
  try{
    const r=await fetch('/auth/check',{credentials:'include'});const d=await r.json();
    if(d.authenticated&&d.user){S.user=d.user;hideSplash();go('dashboard');loadDailyStatus();return}
  }catch{}
  hideSplash();go('landing');
}

function hideSplash(){const sp=document.getElementById('splash');sp.classList.add('hide');setTimeout(()=>sp.style.display='none',400)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister(){
  const name=val('su-name'),username=val('su-user'),email=val('su-email'),password=val('su-pass'),confirm=val('su-conf');
  if(!name||!username||!email||!password){toast('Please fill in all fields');return}
  if(password!==confirm){toast('Passwords do not match');shake('su-conf');return}
  const btn=document.getElementById('su-btn'); btnLoad(btn,'Creatingâ€¦');
  try{const r=await api('/auth/register','POST',{name,username,email,password});S.user=r.user;toast('Welcome to Brainliant! ğŸ‰');confetti();setTimeout(()=>go('dashboard'),600)}
  catch(e){toast(e.message||'Registration failed')}finally{btnReset(btn,'Create Account')}
}
async function doLogin(){
  const email=val('si-email'),password=val('si-pass');
  if(!email||!password){toast('Please enter email and password');return}
  const btn=document.getElementById('si-btn'); btnLoad(btn,'Signing inâ€¦');
  try{const r=await api('/auth/login','POST',{email,password});S.user=r.user;toast('Welcome back, '+r.user.name.split(' ')[0]+'!');go('dashboard')}
  catch(e){toast(e.message||'Invalid credentials');shake('si-pass')}finally{btnReset(btn,'Sign In')}
}
async function doLogout(){
  try{await fetch('/auth/logout',{method:'POST',credentials:'include'})}catch{}
  S.user=null; go('landing'); setTimeout(()=>toast('Signed out'),200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshDash(){
  if(!S.user)return;
  const u=S.user;
  const init=u.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('d-avatar').textContent=init;
  setText('d-name',u.name.split(' ')[0]);
  setText('d-xp-badge','âš¡ '+(u.xp||0)+' XP');
  setText('d-rank-badge',u.rank||'Beginner');
  setText('d-level-badge','Level '+(u.level||1));
  const streakTxt='ğŸ”¥ '+(u.streak||1)+' day'+(u.streak!==1?'s':'');
  setText('d-streak-badge',streakTxt);
  setText('d-streak-badge-welcome',streakTxt);
  document.querySelectorAll('[data-streak]').forEach(el=>el.textContent=streakTxt);
  setText('rp-rank',u.rank||'Beginner');
  setText('rp-next',u.next_rank||'Explorer');
  setText('rp-xp-cur',(u.xp||0)+' XP');
  setText('rp-xp-next',(u.next_rank_xp||500)+' XP to '+u.next_rank);
  setWidth('rp-bar',u.rank_progress||0);
  setText('ds-rank','#'+(u.global_position||'â€”'));
  setText('ds-pct',(u.percentile||0)+'%');
  setText('ds-courses',u.courses||0);
  setText('ds-quizzes',u.quizzes_done||0);
  // Refresh daily streak status
  loadDailyStatus();
  // Check for due reviews
  try{
    const r=await fetch('/user/analytics',{credentials:'include'});const d=await r.json();S._lastAnalytics=d;
    if(d.due_count>0){
      document.getElementById('reviewBanner').style.display='flex';
      setText('dueCount',d.due_count+' topic'+(d.due_count!==1?'s':'')+' due for review');
    }
  }catch{}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD & CONTENT GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let outputTab='quiz';
function setOutputTab(tab,el){
  outputTab=tab;
  document.querySelectorAll('.output-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('quizConfig').style.display=(tab==='summary')?'none':'block';
}

function handleFiles(fList){
  S.files=Array.from(fList);
  S.fileText=''; // will be filled server-side when Generate is clicked
  renderFileList();
  document.getElementById('uploadConfig').style.display=S.files.length?'block':'none';
}

function renderFileList(){
  document.getElementById('fileList').innerHTML=S.files.map((f,i)=>`
    <div class="file-pill">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <span class="fp-name">${f.name}</span><span class="fp-size">${(f.size/1024).toFixed(1)}KB</span>
      <button class="fp-rm" onclick="removeFile(${i})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>`).join('');
}
function removeFile(i){S.files.splice(i,1);renderFileList();if(!S.files.length)document.getElementById('uploadConfig').style.display='none'}

async function generateContent(){
  if(!S.files.length){toast('Please upload at least one file');return}
  const title=val('cTitle')||S.files[0].name.replace(/\.[^/.]+$/,'')||'Course';
  S.currentQuizTitle=title;
  document.getElementById('uploadConfig').style.display='none';
  document.getElementById('genStatus').style.display='block';
  const msgs=['Uploading your filesâ€¦','Extracting content from PDF/DOCXâ€¦','Analysing with Cohere AIâ€¦','Building quiz questionsâ€¦','Almost readyâ€¦'];
  let p=5; const bar=document.getElementById('genBar'),msg=document.getElementById('genMsg');
  const intv=setInterval(()=>{p=Math.min(p+2,88);bar.style.width=p+'%';msg.textContent=msgs[Math.min(Math.floor(p/20),msgs.length-1)]},300);

  try{
    // â”€â”€ STEP 1: Upload files to server, get extracted text back â”€â”€
    msg.textContent='Uploading and reading your filesâ€¦';
    const fd=new FormData();
    S.files.forEach(f=>fd.append('files',f));
    const extractResp=await fetch('/upload/extract',{method:'POST',body:fd,credentials:'include'});
    if(!extractResp.ok){
      const err=await extractResp.json().catch(()=>({}));
      throw new Error(err.error||'File upload failed ('+extractResp.status+'). Are you logged in?');
    }
    const extracted=await extractResp.json();
    const fileText=extracted.text||'';
    if(!fileText.trim()){
      throw new Error('Could not read any content from your files. Try a .txt or .md file, or add a title describing the topic.');
    }
    // Update daily streak status from server response
    if(extracted.daily_status) updateDailyStatus(extracted.daily_status);
    bar.style.width='40%'; msg.textContent='File read â€” '+extracted.char_count+' characters extracted. Sending to AIâ€¦';

    // â”€â”€ STEP 2: Generate quiz and/or summary with the real text â”€â”€
    if(outputTab==='quiz'||outputTab==='both'){
      const numQ=Math.min(30,Math.max(5,parseInt(val('qNum'))||10));
      const diff=val('cDiff')||'intermediate';
      bar.style.width='55%'; msg.textContent='Generating '+numQ+' quiz questions with Cohere AIâ€¦';
      const r=await api('/ai/generate-quiz','POST',{text:fileText,title,num_questions:numQ,difficulty:diff});
      S.quiz=r.questions||[];
      if(!S.quiz.length)throw new Error('AI returned no questions. Please try again.');
    }
    if(outputTab==='summary'||outputTab==='both'){
      bar.style.width='80%'; msg.textContent='Generating smart notes and mind mapâ€¦';
      const r=await api('/ai/generate-summary','POST',{text:fileText,title});
      clearInterval(intv); bar.style.width='100%';
      document.getElementById('genStatus').style.display='none';
      renderSummary(r,title);
      if(outputTab==='summary')return;
    }

    clearInterval(intv); bar.style.width='100%';
    await api('/user/xp','POST',{amount:0,course_done:1});
    document.getElementById('genStatus').style.display='none';
    S.qIdx=0; S.score=0; S.xpEarned=0; S.topicResults=[];
    document.getElementById('quiz-name').textContent=title.slice(0,22)+(title.length>22?'â€¦':'');
    startTimer(); renderQ(); go('quiz');

  }catch(e){
    clearInterval(intv);
    document.getElementById('genStatus').style.display='none';
    document.getElementById('uploadConfig').style.display='block';
    toast('âŒ '+( e.message||'Generation failed'));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQ(){
  const q=S.quiz[S.qIdx]; if(!q){endQuiz();return}
  const tot=S.quiz.length;
  setText('q-prog-lbl',(S.qIdx+1)+'/'+tot);
  setWidth('q-prog-bar',Math.round(((S.qIdx+1)/tot)*100));
  setText('q-num','Question '+(S.qIdx+1)+(q.topic?' Â· '+q.topic:''));
  setText('q-text',q.q);
  setText('q-xp-lbl',S.xpEarned+' XP');
  document.getElementById('q-exp').style.display='none';
  document.getElementById('eli5-exp').style.display='none';
  document.getElementById('q-next').style.display='none';
  const letters=['A','B','C','D'];
  document.getElementById('q-options').innerHTML=q.opts.map((o,i)=>`
    <button class="option-btn" onclick="selectOpt(${i})">
      <div class="option-letter">${letters[i]}</div>
      <span class="option-text">${o.replace(/^[A-D]\)\s*/,'')}</span>
    </button>`).join('');
  // Auto-show ELI5 if mode is on
  if(S.eli5) showELI5(q);
}

function selectOpt(idx){
  const q=S.quiz[S.qIdx]; const letters=['A','B','C','D'];
  const chosen=letters[idx]; const correct=q.ans;
  const opts=document.querySelectorAll('.option-btn');
  opts.forEach(o=>o.classList.add('locked'));
  const isRight=chosen===correct;
  opts[idx].classList.add(isRight?'correct':'wrong');
  if(!isRight){const ci=letters.indexOf(correct);if(ci>=0)opts[ci].classList.add('correct')}
  // Track topic performance
  const topic=q.topic||S.currentQuizTitle||'General';
  const existing=S.topicResults.find(t=>t.topic===topic);
  if(existing){existing.correct+=(isRight?1:0);existing.total++}
  else S.topicResults.push({topic,correct:isRight?1:0,total:1});
  if(isRight){S.score++;const xp=15+Math.floor(Math.random()*15);S.xpEarned+=xp;showXPBurst('+'+xp+' XP')}
  setText('q-exp-text',(isRight?'âœ… Correct! â€” ':'âŒ Incorrect. ')+q.exp);
  document.getElementById('q-exp').style.display='block';
  document.getElementById('q-next').style.display='block';
  // If ELI5 mode is on, show simple explanation
  if(S.eli5) showELI5(q);
}

async function showELI5(q){
  const el=document.getElementById('eli5-exp');
  const loader=document.getElementById('eli5-loader');
  const txt=document.getElementById('eli5-text');
  el.style.display='block'; loader.style.display='flex'; txt.textContent='';
  try{
    const r=await api('/ai/explain-homework','POST'); // reuse endpoint conceptually
    // Actually call via fetch directly for ELI5
    const resp=await fetch('/ai/generate-quiz',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:q.exp+'\n\nQuestion: '+q.q,title:'ELI5',num_questions:1,difficulty:'beginner'})});
    // Simplified: just re-ask cohere via summary
    const sr=await api('/ai/generate-summary','POST',{text:q.q+'\n\n'+q.exp,title:'Simple Explanation'});
    txt.textContent=sr.summary||q.exp;
  }catch{txt.textContent=q.exp}finally{loader.style.display='none'}
}

function toggleELI5(){
  S.eli5=!S.eli5;
  const btn=document.getElementById('eli5Btn');
  btn.classList.toggle('on',S.eli5);
  if(!S.eli5)document.getElementById('eli5-exp').style.display='none';
  toast(S.eli5?'ELI5 Mode ON â€” simple explanations enabled':'ELI5 Mode OFF');
}

function nextQ(){S.qIdx++;renderQ()}

async function endQuiz(){
  clearInterval(S.timerInt);
  const tot=S.quiz.length; const pct=Math.round((S.score/tot)*100);
  setText('sc-pct',pct+'%'); setText('sc-xp','+'+S.xpEarned+' XP');
  setText('sc-cor',S.score+'/'+tot);
  setText('sc-streak','ğŸ”¥'+(S.user?.streak||1));
  const titles=[[90,'Excellent! ğŸ‰'],[70,'Great Work! ğŸ‘'],[50,'Good Effort! ğŸ’ª'],[0,'Keep Going! ğŸ“š']];
  setText('score-title',titles.find(([t])=>pct>=t)[1]);
  setText('score-sub',`You scored ${pct}% and earned ${S.xpEarned} XP!`);
  // Swap mascot image based on score
  const mascot=document.getElementById('scoreMascot');
  if(mascot){
    if(pct>=70){mascot.src='/static/brain_leaderboard.png';mascot.style.animation='brainCheer 1s ease-in-out infinite'}
    else if(pct>=50){mascot.src='/static/brain_quiz.png';mascot.style.animation='brainBounce 1.5s ease-in-out infinite'}
    else{mascot.src='/static/brain_explanation.png';mascot.style.animation='brainIdea 2s ease-in-out infinite'}
  }
  const duration=Math.round(S.timerSec/60);
  const topics=S.topicResults.map(t=>t.topic);
  await addXP(S.xpEarned,1,0,duration,topics);
  if(S.topicResults.length){try{await api('/user/topics','POST',{results:S.topicResults})}catch{}}
  const weak=S.topicResults.filter(t=>t.total>0&&t.correct/t.total<0.6);
  if(weak.length){
    document.getElementById('weakTopicsResult').style.display='block';
    document.getElementById('weakTopicsList').innerHTML=weak.map(t=>`<span class="badge badge-red">${t.topic} (${Math.round(t.correct/t.total*100)}%)</span>`).join('');
  }else{document.getElementById('weakTopicsResult').style.display='none'}
  if(pct>=70)confetti();
  setTimeout(()=>document.getElementById('scoreRing').classList.add('done'),2000);
  go('score');
}

async function addXP(amount,quizDone=0,courseDone=0,duration=0,topics=[]){
  if(!S.user) return;
  try{
    const r=await api('/user/xp','POST',{amount,quiz_done:quizDone,course_done:courseDone,duration_min:duration,topics});
    if(r.user) S.user=r.user;
    if(r.daily_status) updateDailyStatus(r.daily_status);
    // Refresh dashboard streak display
    if(S.user){
      setText('d-streak-badge','ğŸ”¥ '+(S.user.streak||1)+' day'+(S.user.streak!==1?'s':''));
      setText('sc-streak','ğŸ”¥'+(S.user.streak||1));
    }
  }catch(e){ console.warn('addXP error:',e.message) }
}

function retryQuiz(){S.qIdx=0;S.score=0;S.xpEarned=0;S.topicResults=[];startTimer();renderQ();go('quiz')}

async function startAdaptiveQuiz(){
  toast('Building adaptive quiz for your weak topicsâ€¦');
  try{
    const r=await api('/ai/adaptive-quiz','POST',{num_questions:10});
    if(r.error){toast(r.error);return}
    S.quiz=r.questions||[]; S.qIdx=0;S.score=0;S.xpEarned=0;S.topicResults=[];
    S.currentQuizTitle='Adaptive Review';
    document.getElementById('quiz-name').textContent='Adaptive Review';
    startTimer();renderQ();go('quiz');
    if(r.focus_topics)toast('Focusing on: '+r.focus_topics.slice(0,3).join(', '));
  }catch(e){toast(e.message||'Could not load adaptive quiz')}
}

function confirmExitQuiz(){if(confirm('Exit quiz? Progress will be lost.'))go('dashboard')}
function startTimer(){
  clearInterval(S.timerInt);S.timerSec=0;
  S.timerInt=setInterval(()=>{S.timerSec++;const m=String(Math.floor(S.timerSec/60)).padStart(2,'0'),s=String(S.timerSec%60).padStart(2,'0');const el=document.getElementById('q-timer');if(el)el.textContent=m+':'+s},1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY / NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastSummaryData=null;
function renderSummary(data,title){
  lastSummaryData={...data,title};
  const body=document.getElementById('summaryBody');
  document.getElementById('saveNotesBtn').style.display='block';
  let html=`<h2 style="font-size:1.2rem;font-weight:800;letter-spacing:-.3px;margin-bottom:4px">${title}</h2>
    <p style="font-size:.75rem;color:var(--muted);margin-bottom:20px">AI-Generated Study Notes</p>`;
  // Summary
  if(data.summary){
    html+=`<div class="card" style="margin-bottom:16px"><p style="font-size:.8rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Summary</p><p style="font-size:.875rem;line-height:1.7;color:var(--text)">${data.summary}</p></div>`;
  }
  // Mind Map
  if(data.mind_map){
    html+=`<div class="card" style="margin-bottom:16px"><p style="font-size:.8rem;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Mind Map</p>`;
    html+=`<div class="mind-map-canvas" id="mindMapCanvas"><div class="mm-center">${data.mind_map.center||title}</div>`;
    const branches=data.mind_map.branches||[];
    const angles=[0,60,120,180,240,300];
    const r=95;
    branches.slice(0,6).forEach((b,i)=>{
      const angle=(angles[i]||i*60)*Math.PI/180;
      const bx=50+r*Math.cos(angle)*0.45; const by=50+r*Math.sin(angle)*0.35;
      html+=`<div class="mm-branch" style="left:${bx}%;top:${by}%;transform:translate(-50%,-50%)">${b.label}</div>`;
      (b.children||[]).slice(0,2).forEach((c,j)=>{
        const cx=bx+(j===0?-10:10); const cy=by+(angle>Math.PI?-15:15);
        html+=`<div class="mm-child" style="left:${Math.min(90,Math.max(5,cx))}%;top:${Math.min(90,Math.max(5,cy))}%;transform:translate(-50%,-50%)">${c}</div>`;
      });
    });
    html+='</div></div>';
  }
  // Key Points
  if(data.key_points&&data.key_points.length){
    html+=`<div class="card" style="margin-bottom:16px"><p style="font-size:.8rem;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Key Points</p>`;
    data.key_points.forEach((pt,i)=>{
      html+=`<div class="key-point-item"><div class="kp-num">${i+1}</div><div class="kp-text">${pt}</div></div>`;
    });
    html+='</div>';
  }
  // Formulas
  if(data.formulas&&data.formulas.length){
    html+=`<div class="card" style="margin-bottom:16px"><p style="font-size:.8rem;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Key Formulas & Definitions</p>`;
    data.formulas.forEach(f=>{html+=`<div style="padding:8px 12px;background:var(--bg);border-radius:8px;font-size:.82rem;font-family:monospace;margin-bottom:6px;color:var(--text)">${f}</div>`});
    html+='</div>';
  }
  // Difficult areas
  if(data.difficulty_areas&&data.difficulty_areas.length){
    html+=`<div class="card"><p style="font-size:.8rem;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">âš ï¸ Typically Difficult</p>`;
    data.difficulty_areas.forEach(d=>{html+=`<div class="badge badge-red" style="margin-bottom:6px;display:inline-flex">${d}</div><br>`});
    html+='</div>';
  }
  // If came from "both" mode, offer to also do quiz
  if(outputTab==='both'&&S.quiz.length){
    html+=`<button class="btn btn-primary btn-full" style="margin-top:4px" onclick="startTimer();renderQ();go('quiz')">â–¶ Start Quiz Now</button>`;
  }
  body.innerHTML=html;
  go('summary');
}

async function saveNotesOffline(){
  if(!lastSummaryData)return;
  try{
    await api('/quiz/save','POST',{title:lastSummaryData.title+' (Notes)',questions:[{q:'Notes',opts:[''],ans:'A',exp:JSON.stringify(lastSummaryData)}]});
    toast('Notes saved for offline access!');
  }catch(e){toast(e.message||'Could not save')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOMEWORK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setHWTab(tab){
  document.getElementById('hw-explain-mode').style.display=tab==='explain'?'block':'none';
  document.getElementById('hw-check-mode').style.display=tab==='check'?'block':'none';
  document.getElementById('hw-tab-explain').classList.toggle('active',tab==='explain');
  document.getElementById('hw-tab-check').classList.toggle('active',tab==='check');
}

function handleHWImg(input){
  const f=input.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=e=>{
    document.getElementById('hwImgWrap').style.display='block';
    document.getElementById('hwImgWrap').innerHTML=`<img src="${e.target.result}" alt="Homework">`;
    document.getElementById('hwForm').style.display='block';
    document.getElementById('hwDrop').style.display='none';
  }; r.readAsDataURL(f);
}

function handleCkImg(input){
  const f=input.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=e=>{
    document.getElementById('ckImgWrap').style.display='block';
    document.getElementById('ckImgWrap').innerHTML=`<img src="${e.target.result}" alt="Answer">`;
  }; r.readAsDataURL(f);
}

async function explainHW(){
  const mode=val('hwMode')||'detailed'; const desc=val('hwDesc')||'';
  const imgInput=document.getElementById('hwInput');
  if(!imgInput.files[0]&&!desc){toast('Please upload a photo or describe the problem');return}
  document.getElementById('hwLoading').style.display='block';
  document.getElementById('hwForm').style.display='none';
  try{
    const fd=new FormData();
    fd.append('mode',mode);
    fd.append('description',desc);
    if(imgInput.files[0])fd.append('image',imgInput.files[0]);
    const r=await fetch('/ai/explain-homework',{method:'POST',body:fd,credentials:'include'});
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||'Server error ('+r.status+')')}
    const d=await r.json();
    document.getElementById('hwLoading').style.display='none';
    renderHWResult(d.explanation||'No explanation returned.');
    if(d.daily_status) updateDailyStatus(d.daily_status);
    addXP(15,0,0,2,[]);
    toast('+15 XP earned!');
  }catch(e){
    document.getElementById('hwLoading').style.display='none';
    document.getElementById('hwForm').style.display='block';
    toast('âŒ '+(e.message||'Explanation failed'));
  }
}

async function checkSolution(){
  const problem=val('ck-problem'); const answer=val('ck-answer');
  if(!problem&&!answer){toast('Please describe the problem and your answer');return}
  const imgInput=document.getElementById('ckInput');
  document.getElementById('ckLoading').style.display='block';
  document.getElementById('ckResult').style.display='none';
  try{
    const fd=new FormData();
    fd.append('problem',problem);
    fd.append('answer',answer);
    if(imgInput.files[0])fd.append('image',imgInput.files[0]);
    const r=await fetch('/ai/check-solution',{method:'POST',body:fd,credentials:'include'});
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||'Server error ('+r.status+')')}
    const d=await r.json();
    document.getElementById('ckLoading').style.display='none';
    renderCheckResult(d.feedback,d.is_correct);
    if(d.daily_status) updateDailyStatus(d.daily_status);
    if(d.is_correct){addXP(20,0,0,1,[]);confetti();toast('+20 XP â€” Correct! ğŸ‰')}
    else toast('Check the feedback below and try again!');
  }catch(e){
    document.getElementById('ckLoading').style.display='none';
    toast('âŒ '+(e.message||'Check failed'));
  }
}

function renderHWResult(text){
  const lines=text.split('\n').filter(l=>l.trim());
  let html='<div class="card" style="margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700;margin-bottom:16px;color:var(--purple)">AI Explanation</h3>';
  let stepCount=0;
  lines.forEach(line=>{
    if(/^[1-9]\d*\./.test(line.trim())){html+=`<div class="step-block"><h5>Step ${++stepCount}</h5><p>${line.replace(/^\d+\.\s*/,'')}</p></div>`}
    else if(/^#{1,3}\s/.test(line)){html+=`<p style="font-size:.78rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.05em;margin:14px 0 6px">${line.replace(/^#+\s/,'')}</p>`}
    else{html+=`<p style="font-size:.875rem;line-height:1.6;color:var(--text);margin-bottom:8px">${line}</p>`}
  });
  html+='<button class="btn btn-outline btn-full" style="margin-top:16px" onclick="resetHW()">Try Another Problem</button></div>';
  const el=document.getElementById('hwResult'); el.style.display='block'; el.innerHTML=html;
}

function renderCheckResult(feedback,isCorrect){
  const cls=isCorrect?'feedback-correct':'feedback-wrong';
  const icon=isCorrect?'âœ…':'âŒ';
  let html=`<div class="${cls}"><p style="font-size:.9rem;font-weight:700;margin-bottom:10px">${icon} ${isCorrect?'Correct!':'Needs Correction'}</p>`;
  feedback.split('\n').filter(l=>l.trim()).forEach(line=>{
    html+=`<p style="font-size:.85rem;line-height:1.6;margin-bottom:6px">${line}</p>`;
  });
  html+='<button class="btn btn-ghost btn-full btn-sm" style="margin-top:12px" onclick="document.getElementById(\'ckResult\').style.display=\'none\'">Try Another</button></div>';
  const el=document.getElementById('ckResult'); el.style.display='block'; el.innerHTML=html;
}

function resetHW(){
  document.getElementById('hwResult').style.display='none';
  document.getElementById('hwImgWrap').style.display='none';
  document.getElementById('hwDrop').style.display='block';
  document.getElementById('hwForm').style.display='none';
  document.getElementById('hwInput').value='';
  closeCamera('explain');
}

// â”€â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openCamera(target){
  S.cameraTarget=target;
  const videoId='cameraVideo'+target.charAt(0).toUpperCase()+target.slice(1);
  const wrapId='cameraWrap'+target.charAt(0).toUpperCase()+target.slice(1);
  try{
    S.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    document.getElementById(videoId).srcObject=S.cameraStream;
    document.getElementById(wrapId).style.display='block';
    if(target==='explain')document.getElementById('hwDrop').style.display='none';
  }catch{toast('Camera access denied. Please upload a photo instead.')}
}

function captureCamera(target){
  const videoId='cameraVideo'+target.charAt(0).toUpperCase()+target.slice(1);
  const video=document.getElementById(videoId);
  const canvas=document.createElement('canvas'); canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  canvas.toBlob(blob=>{
    const file=new File([blob],'capture.jpg',{type:'image/jpeg'});
    const dt=new DataTransfer(); dt.items.add(file);
    const inputId=target==='explain'?'hwInput':'ckInput';
    document.getElementById(inputId).files=dt.files;
    if(target==='explain')handleHWImg(document.getElementById(inputId));
    else handleCkImg(document.getElementById(inputId));
    closeCamera(target);
  },'image/jpeg',0.9);
}

function closeCamera(target){
  if(S.cameraStream){S.cameraStream.getTracks().forEach(t=>t.stop());S.cameraStream=null}
  const wrapId='cameraWrap'+target.charAt(0).toUpperCase()+target.slice(1);
  const el=document.getElementById(wrapId); if(el)el.style.display='none';
  if(target==='explain'&&!document.getElementById('hwForm').style.display.includes('block'))
    document.getElementById('hwDrop').style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAnalytics(){
  try{
    const r=await fetch('/user/analytics',{credentials:'include'});
    if(!r.ok)return;
    const d=await r.json();
    // Summary tiles
    const u=S.user||{};
    document.getElementById('analyticsTiles').innerHTML=`
      <div class="summary-tile"><div class="st-num" style="color:var(--blue)">${(u.xp||0).toLocaleString()}</div><div class="st-lbl">Total XP</div></div>
      <div class="summary-tile"><div class="st-num" style="color:var(--green)">${d.avg_score||0}%</div><div class="st-lbl">Avg Score</div></div>
      <div class="summary-tile"><div class="st-num" style="color:var(--purple)">${Math.round((d.total_time_min||0)/60*10)/10}h</div><div class="st-lbl">Study Time</div></div>
      <div class="summary-tile"><div class="st-num" style="color:var(--gold)">${(d.topics||[]).length}</div><div class="st-lbl">Topics</div></div>`;
    // Heatmap
    renderHeatmap(d.heatmap||{});
    // Topic bars
    renderTopicBars(d.topics||[]);
    // Weak topics
    if(d.weak_topics&&d.weak_topics.length){
      document.getElementById('weakCard').style.display='block';
      document.getElementById('weakTopicsAnalytics').innerHTML=d.weak_topics.map(t=>`<span class="badge badge-red">${t}</span>`).join('');
    }
  }catch{}
}

function renderHeatmap(data){
  const grid=document.getElementById('heatmapGrid'); grid.innerHTML='';
  const today=new Date(); 
  for(let i=29;i>=0;i--){
    const d=new Date(today); d.setDate(today.getDate()-i);
    const key=d.toISOString().split('T')[0];
    const entry=data[key]; const xp=entry?entry.xp:0;
    const level=xp===0?'':xp<50?'l1':xp<150?'l2':xp<300?'l3':'l4';
    const cell=document.createElement('div');
    cell.className='heat-cell '+(level||'');
    cell.setAttribute('data-tip',key+': '+(xp?xp+' XP':'No activity'));
    cell.title=key+': '+(xp?xp+' XP':'No activity');
    grid.appendChild(cell);
  }
}

function renderTopicBars(topics){
  const el=document.getElementById('topicBars');
  if(!topics.length){el.innerHTML='<p style="font-size:.82rem;color:var(--muted);text-align:center;padding:16px">Complete some quizzes to see topic mastery!</p>';return}
  const colors=['var(--blue)','var(--purple)','var(--green)','var(--gold)','var(--orange)','var(--red)'];
  el.innerHTML=`<div class="topic-bar-wrap">`+topics.map((t,i)=>`
    <div class="topic-bar-row">
      <div class="topic-bar-label" title="${t.topic}">${t.topic}</div>
      <div class="topic-bar-track"><div class="topic-bar-fill" style="width:${t.mastery_pct}%;background:${colors[i%colors.length]}"></div></div>
      <div class="topic-bar-pct" style="color:${colors[i%colors.length]}">${t.mastery_pct}%</div>
    </div>`).join('')+'</div>';
}

async function generateSim(){
  const concept=val('simConcept');
  if(!concept){toast('Enter a concept to simulate');return}
  document.getElementById('simLoading').style.display='flex';
  document.getElementById('simResult').style.display='none';
  try{
    const r=await api('/ai/simulation','POST',{concept});
    document.getElementById('simLoading').style.display='none';
    const el=document.getElementById('simResult'); el.style.display='block';
    // Render in sandboxed iframe for safety
    const iframe=document.createElement('iframe');
    iframe.style.cssText='width:100%;height:320px;border:1px solid var(--border);border-radius:12px;background:var(--white)';
    iframe.sandbox='allow-scripts';
    el.innerHTML=''; el.appendChild(iframe);
    iframe.srcdoc=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box;font-family:sans-serif}body{margin:0;padding:10px;background:#fff}</style></head><body>${r.html||'<p style="color:grey;text-align:center;padding:40px">Could not generate simulation</p>'}</body></html>`;
  }catch(e){document.getElementById('simLoading').style.display='none';toast(e.message||'Simulation failed')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLeaderboard(){
  try{
    const r=await api('/leaderboard'); const lb=r.leaderboard||[]; const total=r.total_users||0;
    const me=lb.find(u=>u.is_me)||{rank:99,xp:S.user?.xp||0};
    setText('lb-my-rank','#'+(me.rank||'â€”'));
    setText('lb-my-sub','out of '+total.toLocaleString()+' users');
    const pct=me.rank?Math.round((1-me.rank/Math.max(total,1))*100):0;
    setText('lb-my-pct','Top '+pct+'%');
    const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    document.getElementById('lbList').innerHTML=lb.map((u,i)=>`
      <div class="lb-row${u.is_me?' lb-me':''}">
        <div class="lb-pos${i===0?' gold':i===1?' silver':i===2?' bronze':''}">${i<3?medals[i]:u.rank}</div>
        <div class="avatar avatar-sm">${u.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()}</div>
        <div class="lb-info"><div class="lb-name">${u.name}${u.is_me?' <span style="color:var(--blue);font-size:.7rem">(You)</span>':''}</div><div class="lb-sub">${u.rank_tier} Â· Lv.${u.level}</div></div>
        <div class="lb-xp">${u.xp.toLocaleString()} XP</div>
      </div>`).join('');
  }catch{document.getElementById('lbList').innerHTML='<p style="text-align:center;color:var(--muted);padding:20px;font-size:.85rem">Could not load leaderboard.</p>'}
}

function setTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  loadLeaderboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshSettings(){
  if(!S.user)return;
  const u=S.user;
  const init=u.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('s-avatar').textContent=init;
  setText('s-name',u.name); setText('s-email',u.email); setText('s-rank',u.rank||'Beginner');
  // Load saved quizzes
  try{
    const r=await api('/quiz/saved');
    const el=document.getElementById('savedQuizList');
    if(!r.quizzes||!r.quizzes.length){el.innerHTML='<p style="font-size:.8rem;color:var(--muted);text-align:center;padding:12px">No saved quizzes yet.<br>Generate a quiz and save it for offline access.</p>';return}
    el.innerHTML=r.quizzes.map(q=>`
      <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="flex:1"><div style="font-size:.85rem;font-weight:600">${q.title}</div><div style="font-size:.72rem;color:var(--muted)">${q.questions.length} items Â· ${new Date(q.created_at).toLocaleDateString()}</div></div>
        <button class="btn btn-secondary btn-sm" onclick="loadSavedQuiz(${JSON.stringify(q).replace(/"/g,'&quot;')})">Start</button>
      </div>`).join('');
  }catch{}
}

function loadSavedQuiz(q){
  S.quiz=q.questions||[]; S.qIdx=0;S.score=0;S.xpEarned=0;S.topicResults=[];
  S.currentQuizTitle=q.title;
  document.getElementById('quiz-name').textContent=q.title.slice(0,22);
  startTimer();renderQ();go('quiz');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function demoQuiz(){
  if(!S.user){toast('Create a free account to start!');setTimeout(()=>go('signup'),1200);return}
  S.quiz=[
    {q:'What technique involves reviewing material at increasing time intervals?',opts:['A) Speed reading','B) Spaced repetition','C) Mind mapping','D) Highlighting'],ans:'B',exp:'Spaced repetition exploits the spacing effect â€” reviewing at increasing intervals dramatically improves long-term retention with minimal effort.','topic':'Study Techniques'},
    {q:'The "testing effect" refers to which phenomenon?',opts:['A) Test anxiety reducing performance','B) Passive re-reading being most effective','C) Active recall strengthening memory more than re-reading','D) Multiple choice being easier than essay'],ans:'C',exp:'The testing effect shows that actively retrieving information from memory is far more powerful for long-term retention than passively studying the same material.','topic':'Cognitive Science'},
    {q:'Why does interleaving outperform blocked practice?',opts:['A) It\'s easier on the brain','B) It forces discrimination between concepts','C) It takes less time','D) It uses more colours'],ans:'B',exp:'Interleaving forces your brain to repeatedly identify which approach applies, building stronger discrimination and flexible thinking â€” even though it feels harder.','topic':'Learning Science'},
  ];
  S.qIdx=0;S.score=0;S.xpEarned=0;S.topicResults=[];S.currentQuizTitle='Demo Quiz';
  document.getElementById('quiz-name').textContent='Demo Quiz';
  startTimer();renderQ();go('quiz');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(url,method='GET',data=null){
  const opts={method,headers:{'Content-Type':'application/json'},credentials:'include'};
  if(data)opts.body=JSON.stringify(data);
  const r=await fetch(url,opts);
  const json=await r.json();
  if(r.status===401){
    // Session expired â€” send user back to sign in
    S.user=null;
    go('signin');
    toast('Session expired â€” please sign in again');
    throw new Error('Not authenticated');
  }
  if(!r.ok)throw new Error(json.error||json.message||'Request failed');
  return json;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function val(id){return(document.getElementById(id)?.value||'').trim()}
function setText(id,txt){const el=document.getElementById(id);if(el)el.textContent=txt}
function setWidth(id,pct){const el=document.getElementById(id);if(el)el.style.width=pct+'%'}

let toastTimer;
function toast(msg){
  let el=document.getElementById('toast');
  if(!el){el=document.createElement('div');el.id='toast';document.body.appendChild(el)}
  el.textContent=msg;el.className='';void el.offsetWidth;
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{el.classList.add('out');setTimeout(()=>{if(el.parentNode)el.remove()},300)},2800);
}

function shake(id){const el=document.getElementById(id);if(!el)return;el.classList.remove('error');void el.offsetWidth;el.classList.add('error')}
function showXPBurst(txt){const el=document.createElement('div');el.className='xp-burst';el.textContent=txt;document.body.appendChild(el);setTimeout(()=>el.remove(),700)}
function confetti(){const cols=['#2563EB','#7C3AED','#10B981','#F59E0B','#EF4444'];for(let i=0;i<40;i++){const p=document.createElement('div');p.className='confetti-piece';p.style.cssText=`left:${10+Math.random()*80}%;background:${cols[i%5]};animation-duration:${2+Math.random()*1.5}s;animation-delay:${Math.random()*.4}s;transform:rotate(${Math.random()*360}deg)`;document.body.appendChild(p);setTimeout(()=>p.remove(),4000)}}
function pwStrength(pw){const c=[(pw.length>=6),(pw.length>=10),(!!pw.match(/[A-Z0-9]/i)&&!!pw.match(/\d/)),(!!pw.match(/[^a-zA-Z0-9]/))];const cols=['#EF4444','#F59E0B','#7C3AED','#10B981'];['sb1','sb2','sb3','sb4'].forEach((id,i)=>{const b=document.getElementById(id);if(b)b.style.background=c[i]?cols[i]:'var(--border)'})}
function animCount(id,target){const el=document.getElementById(id);if(!el)return;let cur=0;const step=Math.ceil(target/50);const t=setInterval(()=>{cur=Math.min(cur+step,target);el.textContent=cur.toLocaleString();if(cur>=target)clearInterval(t)},30)}
function btnLoad(btn,txt){btn.textContent=txt;btn.disabled=true}
function btnReset(btn,txt){btn.textContent=txt;btn.disabled=false}

// Drag and drop for upload
document.addEventListener('DOMContentLoaded',()=>{
  const dz=document.getElementById('dropZone');
  if(dz){dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');handleFiles(e.dataTransfer.files)})}
  init();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MASCOT COMPANION
// Uses local fallbacks with optional Cohere enrichment.
// Only calls API when context is rich (score/weakTopic present).
// Debounced: max 1 call per page change.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _mascotTimer=null;
let _mascotShowing=false;
let _mascotBubbleOpen=false;

const MASCOT_LOCAL={
  landing:   "Hey! I am Brainy. Tap Start to begin.",
  signup:    "One step away from greatness!",
  signin:    "Your brain missed you. Welcome back!",
  dashboard: ()=>`${S.user?.name?.split(' ')[0]||'Hey'}! ${S.user?.xp||0} XP so far. Keep grinding!`,
  upload:    "Drop your file and I will build a quiz in seconds!",
  quiz:      ()=>`Q${S.qIdx+1} of ${S.quiz.length}. Think before you tap!`,
  score:     ()=>`You scored ${Math.round((S.score/Math.max(S.quiz.length,1))*100)}%! ${S.score/Math.max(S.quiz.length,1)>=.7?'Brilliant! Keep it up!':'Every attempt makes you sharper.'}`,
  homework:  "Show me the problem â€” I will break it down step by step.",
  analytics: "Study your weak spots and watch them turn into strengths.",
  leaderboard:()=>`You are rank #${S.user?.global_position||'?'} globally. Keep grinding!`,
  summary:   "Your mind map is ready! Every branch is a key concept.",
  settings:  "Customise away! See you in tomorrow's session.",
};

function getMascotLocal(page){
  const m=MASCOT_LOCAL[page]||"Ready to learn something great today?";
  return typeof m==='function'?m():m;
}

function showMascotMessage(msg){
  const bubble=document.getElementById('mascot-bubble');
  const msgEl=document.getElementById('mascot-msg');
  if(!bubble||!msgEl)return;
  // Show typing dots first
  msgEl.innerHTML='<div class="mascot-typing"><span></span><span></span><span></span></div>';
  bubble.style.display='block';
  _mascotBubbleOpen=true;
  // Then show real message after short delay
  setTimeout(()=>{
    msgEl.textContent=msg;
    bubble.style.animation='none';
    void bubble.offsetWidth;
    bubble.style.animation='bubblePop .3s ease';
  }, msg.includes('thinking')?0:600);
  // Auto-hide after 6 seconds
  clearTimeout(_mascotTimer);
  _mascotTimer=setTimeout(()=>{
    bubble.style.display='none';
    _mascotBubbleOpen=false;
  },6000);
}

function toggleMascotBubble(){
  const bubble=document.getElementById('mascot-bubble');
  if(!bubble)return;
  if(_mascotBubbleOpen){
    bubble.style.display='none';
    _mascotBubbleOpen=false;
    clearTimeout(_mascotTimer);
  } else {
    // Re-show last message or local fallback
    const page=document.querySelector('.page.active')?.id?.replace('pg-','') || 'dashboard';
    showMascotMessage(getMascotLocal(page));
  }
}

// Per-page context builders for optional AI enrichment
function buildMascotContext(page){
  const ctx={};
  if(page==='score'){
    ctx.score=Math.round((S.score/Math.max(S.quiz.length,1))*100);
  }
  if(page==='analytics'&&S._lastAnalytics?.weak_topics?.length){
    ctx.weakTopic=S._lastAnalytics.weak_topics[0];
  }
  if(page==='upload'&&S.files.length){
    ctx.file_title=S.files[0]?.name?.replace(/\.[^/.]+$/,'');
  }
  if(page==='quiz'){
    ctx.qNum=S.qIdx+1; ctx.total=S.quiz.length;
  }
  return ctx;
}

// Called on every go(page) â€” debounced, local-first
let _mascotLastPage='';
async function mascotNotify(page){
  if(!S.user)return; // not logged in
  // Always show local message immediately
  const localMsg=getMascotLocal(page);
  showMascotMessage(localMsg);
  // Only call API if page changed AND context is rich
  if(page===_mascotLastPage)return;
  _mascotLastPage=page;
  const ctx=buildMascotContext(page);
  const hasRichContext=Object.keys(ctx).some(k=>ctx[k]!==undefined&&ctx[k]!==null);
  if(!hasRichContext)return; // local fallback is fine
  // Call API in background â€” update bubble if still open
  try{
    const r=await fetch('/ai/mascot',{method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({page,context:ctx})});
    if(!r.ok)return;
    const d=await r.json();
    if(d.message&&d.source==='ai'&&_mascotBubbleOpen){
      document.getElementById('mascot-msg').textContent=d.message;
    }
  }catch{}
}

</script>
</body>
</html>
